<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mi Control Financiero</title>
  <meta name="theme-color" content="#121212" />

  <style>
    /* ====== RESET & BASE ====== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: #0f0f10;
      color: #f1f1f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 16px;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
      color: #fafafa;
    }

    /* ====== PANEL SUPERIOR ====== */
    .panel {
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, #161616, #121212);
      border: 1px solid #232323;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      align-items: stretch;
    }

    .metric {
      background: #181818;
      border: 1px solid #242424;
      border-radius: 12px;
      padding: 10px 8px;
      text-align: center;
    }
    .metric .label {
      font-size: 12px;
      color: #a9a9a9;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .metric .value {
      font-weight: 700;
      font-size: clamp(16px, 4.3vw, 20px);
    }
    .metric.ahorro .value { color: #4fc3f7; }
    .metric.saldo  .value { color: #66bb6a; }
    .metric.gastos .value { color: #ef5350; }

    /* ====== FORM ====== */
    .input-area {
      width: 100%;
      max-width: 560px;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      margin-top: 6px;
    }
    .input-area input,
    .input-area select,
    .btn {
      border: 1px solid #242424;
      background: #171717;
      color: #fff;
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    .btn {
      cursor: pointer;
      font-weight: 600;
      transition: transform .06s ease, background .2s ease;
      background: #2b7cff;
      border-color: #2b7cff;
    }
    .btn:active { transform: translateY(1px); }
    .btn.secundario {
      background: #202020;
      border-color: #2d2d2d;
    }
    .btn.secundario:hover { background: #262626; }

    .actions {
      width: 100%;
      max-width: 560px;
      display: flex;
      gap: 10px;
      margin-top: 4px;
    }
    .actions .btn { flex: 1; }

    /* ====== HISTORIAL ====== */
    #historial {
      width: 100%;
      max-width: 560px;
      display: none;
      background: #131313;
      border: 1px solid #232323;
      border-radius: 14px;
      margin-top: 10px;
    }
    #historial header {
      padding: 12px 14px;
      border-bottom: 1px solid #232323;
      font-weight: 700;
      font-size: 15px;
      background: #161616;
    }
    .semana {
      padding: 10px 14px 2px;
      border-bottom: 1px dashed #232323;
    }
    .semana .rango {
      font-size: 12px;
      color: #b7b7b7;
      margin-bottom: 8px;
    }
    .registro {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      padding: 8px 0;
      border-bottom: 1px solid #1f1f1f;
      font-size: 14px;
    }
    .registro:last-child { border-bottom: none; }
    .registro .tipo {
      color: #e5e5e5;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .registro .tipo .icono {
      margin-right: 6px;
      font-size: 1.2em;
    }
    .registro .fecha {
      color: #9b9b9b;
      font-size: 12px;
      grid-column: 1 / -1;
      text-align: right;
    }
    .registro .monto {
      justify-self: end;
    }

    /* ====== Notificacion ====== */
    #notificacion {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 15px;
      font-weight: 600;
    }

    @media (max-width: 400px) {
      .input-area { grid-template-columns: 1fr; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>üí∞ Mi Control Financiero</h1>

  <section class="panel">
    <div class="metrics">
      <div class="metric ahorro">
        <div class="label">Ahorro</div>
        <div id="ahorro" class="value">$0.00</div>
      </div>
      <div class="metric saldo">
        <div class="label">Saldo total</div>
        <div id="saldo" class="value">$0.00</div>
      </div>
      <div class="metric gastos">
        <div class="label">Gastos</div>
        <div id="gastos" class="value">$0.00</div>
      </div>
    </div>
  </section>

  <section class="input-area">
    <input type="number" id="monto" inputmode="decimal" step="0.01" placeholder="Monto (ej. 2000, -200 solo en Ahorro)" />
    <select id="tipo">
      <option value="Sueldo">Sueldo</option>
      <option value="Ahorro">Ahorro</option>
      <option value="Mandado">Mandado</option>
      <option value="Gastos del hogar">Gastos del hogar</option>
      <option value="Efectivo">Efectivo</option>
      <option value="Telmex">Telmex</option>
      <option value="CFE">CFE</option>
      <option value="Tienda">Tienda</option>
      <option value="Corning">Corning</option>
      <option value="Didi">Didi</option>
      <option value="iCloud">iCloud</option>
      <option value="Coppel">Coppel</option>
      <option value="Otros">Otros</option>
    </select>
    <button class="btn" id="btn-confirmar">Confirmar</button>
  </section>

  <section class="actions">
    <button class="btn secundario" id="btn-historial">üìú Consultar movimientos</button>
  </section>

  <section id="historial">
    <header>Historial por semana (Jue ‚Üí Mi√©)</header>
    <div id="contenedorSemanas"></div>
  </section>

  <div id="notificacion" style="display: none;">‚úÖ Transacci√≥n registrada</div>

  <script>
    const fmt = new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN" });
    const mesesCortos = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];

    function inicioSemanaJueves(fecha) {
      const d = new Date(fecha);
      d.setHours(0,0,0,0);
      const day = d.getDay();
      const diff = (day - 4 + 7) % 7;
      d.setDate(d.getDate() - diff);
      return d;
    }
    function finSemanaDesdeInicio(inicio) {
      const end = new Date(inicio);
      end.setDate(end.getDate() + 6);
      end.setHours(23,59,59,999);
      return end;
    }
    function rangoSemanaTexto(inicio) {
      const fin = finSemanaDesdeInicio(inicio);
      return `Semana: Jue ${inicio.getDate()} ${mesesCortos[inicio.getMonth()]} ${inicio.getFullYear()} ‚Äî Mi√© ${fin.getDate()} ${mesesCortos[fin.getMonth()]} ${fin.getFullYear()}`;
    }
    function fechaDisplay(tipo, dateObj = new Date()) {
      const dd = String(dateObj.getDate()).padStart(2,"0");
      const mm = String(dateObj.getMonth()+1).padStart(2,"0");
      const yyyy = dateObj.getFullYear();
      if (tipo === "Sueldo") return `${dd}/${mm}/${yyyy}`;
      const hh = String(dateObj.getHours()).padStart(2,"0");
      const min = String(dateObj.getMinutes()).padStart(2,"0");
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }

    const state = (() => {
      const saved = JSON.parse(localStorage.getItem("finanzas") || "{}");
      return Object.assign({ saldo:0, ahorro:0, gastos:0, registros:[], ultimaCorte:null }, saved);
    })();

    function persist() {
      localStorage.setItem("finanzas", JSON.stringify(state));
    }

    function aplicarCortesPendientes() {
      const hoy = new Date();
      const ultimoJuevesHoy = inicioSemanaJueves(hoy);
      if (!state.ultimaCorte) {
        state.ultimaCorte = ultimoJuevesHoy.toISOString();
        persist();
        return;
      }
      let corte = new Date(state.ultimaCorte);
      while (inicioSemanaJueves(corte).getTime() < ultimoJuevesHoy.getTime()) {
        state.registros.push({ tipo:"CIERRE", monto:0, fecha:fechaDisplay("Otros", corte), ts:corte.getTime() });
        state.gastos = 0;
        corte.setDate(corte.getDate()+7);
      }
      state.ultimaCorte = ultimoJuevesHoy.toISOString();
      persist();
    }

    const $saldo = document.getElementById("saldo");
    const $ahorro = document.getElementById("ahorro");
    const $gastos = document.getElementById("gastos");
    const $monto = document.getElementById("monto");
    const $tipo  = document.getElementById("tipo");
    const $btnConfirmar = document.getElementById("btn-confirmar");
    const $btnHistorial = document.getElementById("btn-historial");
    const $historial = document.getElementById("historial");
    const $contenedorSemanas = document.getElementById("contenedorSemanas");
    const $notificacion = document.getElementById("notificacion");

    function mostrarNotificacion(mensaje) {
        $notificacion.textContent = mensaje;
        $notificacion.style.display = "block";
        setTimeout(() => {
            $notificacion.style.display = "none";
        }, 2000);
    }

    function renderResumen() {
      $saldo.textContent  = fmt.format(state.saldo);
      $ahorro.textContent = fmt.format(state.ahorro);
      $gastos.textContent = fmt.format(state.gastos);
    }

    function agregarRegistro() {
      const raw = $monto.value.trim();
      if (!raw) {
        mostrarNotificacion("‚ùó Ingresa un monto");
        return;
      }
      const monto = parseFloat(raw);
      if (isNaN(monto) || monto === 0) {
        mostrarNotificacion("‚ùó Monto inv√°lido");
        return;
      }
      const tipo = $tipo.value;
      const now = new Date();
      const registro = {
          tipo,
          monto,
          fecha: fechaDisplay(tipo, now),
          ts: now.getTime()
      };

      if (tipo === "Sueldo") {
        state.saldo += monto;
      } else if (tipo === "Ahorro") {
        if (monto < 0) {
          state.ahorro += monto;
          state.saldo += monto;
        } else {
          state.ahorro += monto;
          state.saldo -= monto;
        }
      } else {
        state.gastos += monto;
        state.saldo -= monto;
      }

      state.registros.push(registro);
      $monto.value = "";
      $tipo.value = "Sueldo"; // Reseteamos el selector
      persist();
      renderResumen();
      mostrarNotificacion("‚úÖ Transacci√≥n registrada");
    }

    function obtenerIconoTipo(tipo) {
        const gastos = ["Mandado", "Gastos del hogar", "Efectivo", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros", "CIERRE"];
        if (tipo === "Sueldo") return "üü¢";
        if (tipo === "Ahorro") return "üü°";
        if (gastos.includes(tipo)) return "üî¥";
        return "";
    }

    function agruparPorSemana() {
      const grupos = new Map();
      for (const r of state.registros) {
        const inicio = inicioSemanaJueves(r.ts);
        const key = inicio.toISOString();
        if (!grupos.has(key)) grupos.set(key, { inicio, items: [] });
        grupos.get(key).items.push(r);
      }
      return Array.from(grupos.values()).sort((a,b) => b.inicio - a.inicio);
    }

    function renderHistorial() {
      $contenedorSemanas.innerHTML = "";
      const grupos = agruparPorSemana();
      for (const g of grupos) {
        const divSemana = document.createElement("div");
        divSemana.className = "semana";
        const rango = document.createElement("div");
        rango.className = "rango";
        rango.textContent = rangoSemanaTexto(g.inicio);
        divSemana.appendChild(rango);

        g.items.sort((a,b)=>b.ts-a.ts).forEach(r => {
          const div = document.createElement("div");
          div.className = "registro";
          const icono = obtenerIconoTipo(r.tipo);
          div.innerHTML = `<div class="tipo"><span class="icono">${icono}</span>${r.tipo}</div><div class="monto">${fmt.format(r.monto)}</div><div class="fecha">${r.fecha}</div>`;
          divSemana.appendChild(div);
        });
        $contenedorSemanas.appendChild(divSemana);
      }
    }

    function toggleHistorial() {
      if ($historial.style.display === "block") {
        $historial.style.display = "none";
      } else {
        renderHistorial();
        $historial.style.display = "block";
      }
    }

    aplicarCortesPendientes();
    renderResumen();
    $btnConfirmar.addEventListener("click", agregarRegistro);
    $monto.addEventListener("keydown", e => { if (e.key === "Enter") agregarRegistro(); });
    $btnHistorial.addEventListener("click", toggleHistorial);
  </script>
</body>
</html>
