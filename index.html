<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mi Control Financiero</title>
  <meta name="theme-color" content="#121212" />

  <style>
    /* ====== RESET & BASE ====== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: #0f0f10;
      color: #f1f1f1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 16px;
      overflow-x: hidden;
      position: relative;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
      color: #fafafa;
    }

    /* ====== PANEL SUPERIOR ====== */
    .panel {
      width: 100%;
      max-width: 560px;
      background: linear-gradient(180deg, #161616, #121212);
      border: 1px solid #232323;
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      align-items: stretch;
    }

    .metric {
      background: #181818;
      border: 1px solid #242424;
      border-radius: 12px;
      padding: 10px 8px;
      text-align: center;
    }
    .metric .label {
      font-size: 12px;
      color: #a9a9a9;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .metric .value {
      font-weight: 700;
      font-size: clamp(16px, 4.3vw, 20px);
    }
    .metric.ahorro .value { color: #4fc3f7; }
    .metric.saldo  .value { color: #66bb6a; }
    .metric.gastos .value { color: #ef5350; }

    /* ====== MAIN FORM & ACTIONS ====== */
    #main-screen {
      width: 100%;
      max-width: 560px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }

    .input-area {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
    }
    .input-area input,
    .input-area select,
    .btn {
      border: 1px solid #242424;
      background: #171717;
      color: #fff;
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
    }
    .btn {
      cursor: pointer;
      font-weight: 600;
      transition: transform .06s ease, background .2s ease;
      background: #2b7cff;
      border-color: #2b7cff;
    }
    .btn:active { transform: translateY(1px); }
    .btn.secundario {
      background: #202020;
      border-color: #2d2d2d;
    }
    .btn.secundario:hover { background: #262626; }

    .actions {
      width: 100%;
      display: flex;
      gap: 10px;
      margin-top: -8px;
    }
    .actions .btn { flex: 1; }

    /* ====== PANTALLA DE MANDADO ====== */
    #mandado-screen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #0f0f10;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: transform .3s ease;
      transform: translateX(100%);
      align-items: center;
    }
    #mandado-screen.active {
      transform: translateX(0);
    }
    #mandado-screen header {
      width: 100%;
      max-width: 560px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #mandado-screen .input-item {
      width: 100%;
      max-width: 560px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
    }
    #mandado-screen .input-item .grid-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    #mandado-screen #lista-mandado {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 560px;
      margin: 0;
      flex: 1;
      overflow-y: auto;
      border: 1px solid #232323;
      border-radius: 12px;
      background: #131313;
    }
    #mandado-screen #lista-mandado li {
      display: flex;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid #1f1f1f;
      font-size: 15px;
    }
    #mandado-screen #lista-mandado li:last-child {
      border-bottom: none;
    }
    #mandado-screen #lista-mandado li .nombre { color: #ccc; }
    #mandado-screen #lista-mandado li .precio { font-weight: 600; }

    #mandado-screen .total-container {
      width: 100%;
      max-width: 560px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      padding: 14px;
      border-radius: 12px;
      background: #181818;
    }
    #mandado-screen .total-container .valor { color: #66bb6a; }

    /* ====== HISTORIAL & GRAFICO ====== */
    #historial {
      width: 100%;
      max-width: 560px;
      display: none;
      background: #131313;
      border: 1px solid #232323;
      border-radius: 14px;
      margin-top: 10px;
    }
    #historial header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid #232323;
      font-weight: 700;
      font-size: 15px;
      background: #161616;
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
    }
    
    .tabs {
        display: flex;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
    }
    .tab {
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        background: #202020;
    }
    .tab.active {
        background: #2b7cff;
        color: white;
    }

    .historial-content {
      padding: 0;
    }
    .semana, .mes {
      padding: 10px 14px 2px;
      border-bottom: 1px dashed #232323;
    }
    .semana .rango, .mes .rango {
      font-size: 12px;
      color: #b7b7b7;
      margin-bottom: 8px;
    }
    .registro {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 6px;
      padding: 8px 0;
      border-bottom: 1px solid #1f1f1f;
      font-size: 14px;
      align-items: center;
    }
    .registro:last-child { border-bottom: none; }
    .registro .tipo {
      color: #e5e5e5;
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .registro .tipo .icono {
      margin-right: 6px;
      font-size: 1.2em;
    }
    .registro .fecha {
      color: #9b9b9b;
      font-size: 12px;
      grid-column: 1 / -1;
      text-align: right;
    }
    .registro .monto {
      justify-self: end;
      font-weight: 600;
    }
    .registro .delete-btn {
      background: none;
      border: none;
      color: #ef5350;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
    }

    /* ====== GRAFICO CIRCULAR ====== */
    #chart-container {
        padding: 16px 14px;
        background: #131313;
        display: none;
        border-bottom-left-radius: 14px;
        border-bottom-right-radius: 14px;
        border: 1px solid #232323;
        border-top: none;
    }
    #chart-container h3 {
        margin: 0 0 10px;
        font-size: 16px;
        color: #ddd;
    }
    #chart {
        width: 100%;
        height: 250px;
        max-width: 300px;
        margin: auto;
    }

    /* ====== Notificacion ====== */
    #notificacion {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #4CAF50;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    @media (max-width: 500px) {
      .input-area { 
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .input-area button {
        width: 100%;
      }
      .registro { grid-template-columns: 1fr 1fr auto auto; }
      .registro .fecha { grid-column: auto; text-align: left; margin-top: 4px; }
      #mandado-screen .input-item { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>💰 Mi Control Financiero</h1>

  <section class="panel">
    <div class="metrics">
      <div class="metric ahorro">
        <div class="label">Ahorro</div>
        <div id="ahorro" class="value">$0.00</div>
      </div>
      <div class="metric saldo">
        <div class="label">Saldo total</div>
        <div id="saldo" class="value">$0.00</div>
      </div>
      <div class="metric gastos">
        <div class="label">Gastos</div>
        <div id="gastos" class="value">$0.00</div>
      </div>
    </div>
  </section>

  <div id="main-screen">
      <section class="input-area">
        <input type="number" id="monto" placeholder="Monto (ej. 2000, -200 para retirar de Ahorro)" />
        <select id="tipo">
          <option value="Sueldo">Sueldo</option>
          <option value="Ahorro">Ahorro</option>
          <option value="Mandado">Mandado</option>
          <option value="Efectivo">Efectivo</option>
          <option value="Telmex">Telmex</option>
          <option value="CFE">CFE</option>
          <option value="Tienda">Tienda</option>
          <option value="Corning">Corning</option>
          <option value="Didi">Didi</option>
          <option value="iCloud">iCloud</option>
          <option value="Coppel">Coppel</option>
          <option value="Otros">Otros</option>
        </select>
        <button class="btn" id="btn-confirmar">Confirmar</button>
      </section>

      <section class="actions">
        <button class="btn secundario" id="btn-historial">📜 Ver historial y análisis</button>
        <button class="btn secundario" id="btn-mandado">🛒 Ir al Mandado</button>
      </section>

      <section id="historial">
        <header>
          Historial
          <div class="tabs">
              <div class="tab active" data-view="semana">Semanal</div>
              <div class="tab" data-view="mes">Mensual</div>
              <div class="tab" data-view="analisis">Análisis</div>
          </div>
        </header>
        <div id="contenedorSemanas" class="historial-content"></div>
        <div id="contenedorMeses" class="historial-content" style="display: none;"></div>
        <div id="chart-container" class="historial-content" style="display: none;">
            <h3>Distribución de Gastos</h3>
            <canvas id="chart"></canvas>
        </div>
      </section>
  </div>
  
  <section id="mandado-screen">
      <header>
          <h2>Ticket del Mandado</h2>
          <button class="btn secundario" id="btn-volver">Volver</button>
      </header>
      
      <div class="input-item">
          <select id="mandado-categoria">
              <option value="">Selecciona Categoría</option>
              <option value="Frutas y Verduras">Frutas y Verduras</option>
              <option value="Abarrotes">Abarrotes</option>
              <option value="Higiene Personal">Higiene Personal</option>
              <option value="Carnes">Carnes</option>
              <option value="Otros">Otros</option>
          </select>
          <select id="mandado-producto" style="display: none;"></select>
          <input type="text" id="nombre-articulo" placeholder="Nombre del artículo" style="display: none;">

          <div class="grid-inputs">
              <input type="number" id="mandado-peso" placeholder="Peso (ej. 0.800)" step="0.01" style="display: none;">
              <input type="number" id="mandado-precio" placeholder="Precio (ej. 20.00)" step="0.01" style="display: none;">
          </div>
          <button class="btn" id="btn-agregar-articulo" style="display: none;">➕</button>
      </div>

      <ul id="lista-mandado">
          </ul>

      <div class="total-container">
          <span>Total del ticket:</span>
          <span class="valor" id="total-ticket">$0.00</span>
      </div>

      <button class="btn" id="btn-guardar-ticket">✅ Guardar Ticket</button>
  </section>

  <div id="notificacion" style="display: none;"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const fmt = new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN" });
    const mesesLargos = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const mesesCortos = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
    let myChart;
    let mandadoTicket = { items: [], total: 0 };

    const productosMandado = {
        "Frutas y Verduras": [
            "Aguacate", "Ajo", "Apio", "Brócoli", "Calabaza", "Camote", "Cebolla", "Cebollín",
            "Chayote", "Chile Habanero", "Chile Jalapeño", "Chile Poblano", "Cilantro", "Ciruela",
            "Coco", "Durazno", "Ejotes", "Elotes", "Espinaca", "Fresas", "Germen de Soya", "Guayaba",
            "Jamaica", "Lechuga", "Limón", "Mango", "Manzanas", "Melón", "Naranjas", "Nopales",
            "Papa", "Papaya", "Pera", "Plátano", "Repollo", "Sandia", "Tamarindo", "Tomate", "Tuna",
            "Uva", "Zacate de Limón", "Zanahoria"
        ],
        "Abarrotes": ["Aceite", "Ajo en polvo", "Arroz", "Arroz con leche", "Otros Abarrotes"],
        "Higiene Personal": ["Shampoo", "Jabón", "Pasta dental", "Otros Higiene"],
        "Carnes": ["Carne de res", "Pollo", "Pescado", "Otros Carnes"],
        "Otros": ["Otros"]
    };

    function inicioSemanaJueves(fecha) {
      const d = new Date(fecha);
      d.setHours(0,0,0,0);
      const day = d.getDay();
      const diff = (day - 4 + 7) % 7;
      d.setDate(d.getDate() - diff);
      return d;
    }
    function finSemanaDesdeInicio(inicio) {
      const end = new Date(inicio);
      end.setDate(end.getDate() + 6);
      end.setHours(23,59,59,999);
      return end;
    }
    function rangoSemanaTexto(inicio) {
      const fin = finSemanaDesdeInicio(inicio);
      return `Semana: Jue ${inicio.getDate()} ${mesesCortos[inicio.getMonth()]} ${inicio.getFullYear()} — Mié ${fin.getDate()} ${mesesCortos[fin.getMonth()]} ${fin.getFullYear()}`;
    }
    function fechaDisplay(tipo, dateObj = new Date()) {
      const dd = String(dateObj.getDate()).padStart(2,"0");
      const mm = String(dateObj.getMonth()+1).padStart(2,"0");
      const yyyy = dateObj.getFullYear();
      if (tipo === "Sueldo") return `${dd}/${mm}/${yyyy}`;
      const hh = String(dateObj.getHours()).padStart(2,"0");
      const min = String(dateObj.getMinutes()).padStart(2,"0");
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }
    function obtenerMesAno(timestamp) {
        const fecha = new Date(timestamp);
        return `${mesesLargos[fecha.getMonth()]} ${fecha.getFullYear()}`;
    }

    const state = (() => {
      const saved = JSON.parse(localStorage.getItem("finanzas") || "{}");
      if (saved.registros) {
        saved.registros = saved.registros.map(r => {
            if (!r.id) {
                r.id = r.ts;
            }
            return r;
        });
      }
      return Object.assign({ saldo:0, ahorro:0, gastos:0, registros:[], ultimaCorte:null }, saved);
    })();

    function persist() {
      localStorage.setItem("finanzas", JSON.stringify(state));
    }

    function aplicarCortesPendientes() {
      const hoy = new Date();
      const ultimoJuevesHoy = inicioSemanaJueves(hoy);
      if (!state.ultimaCorte) {
        state.ultimaCorte = ultimoJuevesHoy.toISOString();
        persist();
        return;
      }
      let corte = new Date(state.ultimaCorte);
      while (inicioSemanaJueves(corte).getTime() < ultimoJuevesHoy.getTime()) {
        state.registros.push({ id: Date.now(), tipo:"CIERRE", monto:0, fecha:fechaDisplay("Otros", corte), ts:corte.getTime() });
        state.gastos = 0;
        corte.setDate(corte.getDate()+7);
      }
      state.ultimaCorte = ultimoJuevesHoy.toISOString();
      persist();
    }

    const $saldo = document.getElementById("saldo");
    const $ahorro = document.getElementById("ahorro");
    const $gastos = document.getElementById("gastos");
    const $monto = document.getElementById("monto");
    const $tipo  = document.getElementById("tipo");
    const $btnConfirmar = document.getElementById("btn-confirmar");
    const $btnHistorial = document.getElementById("btn-historial");
    const $btnMandado = document.getElementById("btn-mandado");
    const $historial = document.getElementById("historial");
    const $contenedorSemanas = document.getElementById("contenedorSemanas");
    const $contenedorMeses = document.getElementById("contenedorMeses");
    const $notificacion = document.getElementById("notificacion");
    const $tabs = document.querySelectorAll('.tab');
    const $chartContainer = document.getElementById('chart-container');
    const historialContentContainers = document.querySelectorAll('.historial-content');
    const $mainScreen = document.getElementById('main-screen');
    const $mandadoScreen = document.getElementById('mandado-screen');
    const $mandadoCategoria = document.getElementById('mandado-categoria');
    const $mandadoProducto = document.getElementById('mandado-producto');
    const $nombreArticulo = document.getElementById('nombre-articulo');
    const $mandadoPeso = document.getElementById('mandado-peso');
    const $mandadoPrecio = document.getElementById('mandado-precio');
    const $btnAgregarArticulo = document.getElementById('btn-agregar-articulo');
    const $listaMandado = document.getElementById('lista-mandado');
    const $totalTicket = document.getElementById('total-ticket');
    const $btnGuardarTicket = document.getElementById('btn-guardar-ticket');
    const $btnVolver = document.getElementById('btn-volver');

    function mostrarNotificacion(mensaje, tipo = 'exito') {
        $notificacion.textContent = mensaje;
        $notificacion.style.backgroundColor = (tipo === 'exito') ? '#4CAF50' : '#F4436A';
        $notificacion.style.display = "block";
        setTimeout(() => {
            $notificacion.style.display = "none";
        }, 2500);
    }

    function renderResumen() {
      $saldo.textContent  = fmt.format(state.saldo);
      $ahorro.textContent = fmt.format(state.ahorro);
      $gastos.textContent = fmt.format(state.gastos);
    }

    function agregarRegistro(tipo, monto, id = null) {
      if (isNaN(monto) || monto === 0) {
        mostrarNotificacion("❗ Monto inválido", 'error');
        return;
      }
      const now = new Date();
      const registro = {
          id: id || now.getTime(),
          tipo,
          monto,
          fecha: fechaDisplay(tipo, now),
          ts: now.getTime()
      };

      if (tipo === "Sueldo") {
        state.saldo += monto;
      } else if (tipo === "Ahorro") {
        if (monto < 0) {
          state.ahorro += monto;
          state.saldo -= monto; // Se corrige para que también afecte al saldo total
        } else {
          state.ahorro += monto;
          state.saldo -= monto;
        }
      } else {
        state.gastos += monto;
        state.saldo -= monto;
      }

      state.registros.push(registro);
      persist();
      renderResumen();
      mostrarNotificacion("✅ Transacción registrada");
      renderHistorial();
    }
    
    function eliminarRegistro(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este registro?')) {
            return;
        }

        const index = state.registros.findIndex(r => r.id == id);
        if (index === -1) {
            mostrarNotificacion("❌ Registro no encontrado", 'error');
            return;
        }
        
        const registro = state.registros[index];
        const { tipo, monto } = registro;

        if (tipo === "Sueldo") {
            state.saldo -= monto;
        } else if (tipo === "Ahorro") {
            if (monto < 0) {
                state.ahorro -= monto;
                state.saldo += monto; // Invertimos la lógica para revertir la acción
            } else {
                state.ahorro -= monto;
                state.saldo += monto;
            }
        } else {
            state.gastos -= monto;
            state.saldo += monto;
        }

        state.registros.splice(index, 1);
        persist();
        renderResumen();
        renderHistorial();
        mostrarNotificacion("🗑️ Registro eliminado");
    }

    function obtenerIconoTipo(tipo) {
        const gastos = ["Mandado", "Efectivo", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros", "CIERRE"];
        if (tipo === "Sueldo") return "🟢";
        if (tipo === "Ahorro") return "🟡";
        if (gastos.includes(tipo)) return "🔴";
        return "";
    }

    function crearRegistroHTML(registro) {
        const div = document.createElement("div");
        div.className = "registro";
        const icono = obtenerIconoTipo(registro.tipo);
        div.innerHTML = `<div class="tipo"><span class="icono">${icono}</span>${registro.tipo}</div><div class="monto">${fmt.format(registro.monto)}</div><button class="delete-btn" data-id="${registro.id}">✖️</button><div class="fecha">${registro.fecha}</div>`;
        return div;
    }

    function agruparPorSemana() {
      const grupos = new Map();
      for (const r of state.registros) {
        const inicio = inicioSemanaJueves(r.ts);
        const key = inicio.toISOString();
        if (!grupos.has(key)) grupos.set(key, { inicio, items: [] });
        grupos.get(key).items.push(r);
      }
      return Array.from(grupos.values()).sort((a,b) => b.inicio - a.inicio);
    }
    
    function agruparPorMes() {
        const grupos = new Map();
        for (const r of state.registros) {
            const mesAno = obtenerMesAno(r.ts);
            if (!grupos.has(mesAno)) grupos.set(mesAno, { nombre: mesAno, items: [] });
            grupos.get(mesAno).items.push(r);
        }
        // Ordenar por fecha del primer elemento de cada mes, de más reciente a más antiguo
        return Array.from(grupos.values()).sort((a, b) => b.items[0].ts - a.items[0].ts);
    }

    function renderHistorial() {
      $contenedorSemanas.innerHTML = "";
      const gruposSemanas = agruparPorSemana();
      for (const g of gruposSemanas) {
        const divSemana = document.createElement("div");
        divSemana.className = "semana";
        const rango = document.createElement("div");
        rango.className = "rango";
        rango.textContent = rangoSemanaTexto(g.inicio);
        divSemana.appendChild(rango);

        g.items.sort((a,b)=>b.ts-a.ts).forEach(r => {
          const registroEl = crearRegistroHTML(r);
          divSemana.appendChild(registroEl);
        });
        $contenedorSemanas.appendChild(divSemana);
      }

      $contenedorMeses.innerHTML = "";
      const gruposMeses = agruparPorMes();
      for (const g of gruposMeses) {
          const divMes = document.createElement("div");
          divMes.className = "mes";
          const rango = document.createElement("div");
          rango.className = "rango";
          rango.textContent = g.nombre;
          divMes.appendChild(rango);

          g.items.sort((a,b)=>b.ts-a.ts).forEach(r => {
              const registroEl = crearRegistroHTML(r);
              divMes.appendChild(registroEl);
          });
          $contenedorMeses.appendChild(divMes);
      }
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => eliminarRegistro(e.currentTarget.dataset.id));
      });
    }

    function renderChart() {
        const gastos = state.registros.filter(r => {
            const tipoGastos = ["Mandado", "Efectivo", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros"];
            return tipoGastos.includes(r.tipo);
        });
        
        const gastosPorCategoria = gastos.reduce((acc, curr) => {
            acc[curr.tipo] = (acc[curr.tipo] || 0) + curr.monto;
            return acc;
        }, {});
        
        const labels = Object.keys(gastosPorCategoria);
        const data = Object.values(gastosPorCategoria);
        
        if (myChart) myChart.destroy();
        
        const ctx = document.getElementById('chart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#E7E9ED', '#A0522D', '#20B2AA', '#778899', '#D2691E', '#CD5C5C'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#e5e5e5'
                        }
                    }
                }
            }
        });
    }

    function toggleHistorial() {
      if ($historial.style.display === "block") {
        $historial.style.display = "none";
      } else {
        $historial.style.display = "block";
        handleTabClick({ currentTarget: document.querySelector('.tab.active') });
      }
    }
    
    function handleTabClick(event) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
        const view = event.currentTarget.dataset.view;
        
        historialContentContainers.forEach(c => c.style.display = 'none');
        
        if (view === 'semana') {
            $contenedorSemanas.style.display = 'block';
            renderHistorial();
        } else if (view === 'mes') {
            $contenedorMeses.style.display = 'block';
            renderHistorial();
        } else if (view === 'analisis') {
            $chartContainer.style.display = 'block';
            renderChart();
        }
    }

    // Funcionalidad de Mandado
    function mostrarPantallaMandado() {
        $mainScreen.style.transform = "translateX(-100%)";
        $mandadoScreen.classList.add('active');
    }
    function ocultarPantallaMandado() {
        $mainScreen.style.transform = "translateX(0)";
        $mandadoScreen.classList.remove('active');
        // Limpiar el ticket al volver
        mandadoTicket = { items: [], total: 0 };
        renderMandadoList();
        $mandadoCategoria.value = '';
        $mandadoProducto.style.display = 'none';
        $nombreArticulo.style.display = 'none';
        $mandadoPeso.style.display = 'none';
        $mandadoPrecio.style.display = 'none';
        $btnAgregarArticulo.style.display = 'none';
    }

    function actualizarProductosDropdown() {
        const categoria = $mandadoCategoria.value;
        const productos = productosMandado[categoria] || [];
        $mandadoProducto.innerHTML = `<option value="">Selecciona Producto</option>`;
        
        if (categoria) {
            productos.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                $mandadoProducto.appendChild(option);
            });
            $mandadoProducto.style.display = (categoria === 'Otros') ? 'none' : 'block';
            $nombreArticulo.style.display = (categoria === 'Otros') ? 'block' : 'none';
            $mandadoPeso.style.display = (categoria === 'Frutas y Verduras') ? 'block' : 'none';
            $mandadoPrecio.style.display = 'block';
            $btnAgregarArticulo.style.display = 'block';
        } else {
            $mandadoProducto.style.display = 'none';
            $nombreArticulo.style.display = 'none';
            $mandadoPeso.style.display = 'none';
            $mandadoPrecio.style.display = 'none';
            $btnAgregarArticulo.style.display = 'none';
        }
    }
    
    function agregarArticulo() {
        const categoria = $mandadoCategoria.value;
        let nombre = '';
        let monto = 0;
        
        if (categoria === 'Otros') {
            nombre = $nombreArticulo.value.trim();
        } else {
            nombre = $mandadoProducto.value;
        }

        if (!nombre) {
            mostrarNotificacion("❗ Selecciona un producto", 'error');
            return;
        }

        if (categoria === "Frutas y Verduras") {
            const peso = parseFloat($mandadoPeso.value);
            const precio = parseFloat($mandadoPrecio.value);
            if (isNaN(peso) || isNaN(precio) || peso <= 0 || precio <= 0) {
                mostrarNotificacion("❗ Ingresa peso y precio válidos", 'error');
                return;
            }
            monto = peso * precio;
        } else {
            const precio = parseFloat($mandadoPrecio.value);
            if (isNaN(precio) || precio <= 0) {
                mostrarNotificacion("❗ Ingresa un precio válido", 'error');
                return;
            }
            monto = precio;
        }

        mandadoTicket.items.push({ nombre, monto });
        mandadoTicket.total += monto;

        renderMandadoList();
        $nombreArticulo.value = '';
        $mandadoPeso.value = '';
        $mandadoPrecio.value = '';
        $mandadoCategoria.value = '';
        $mandadoProducto.style.display = 'none';
        $nombreArticulo.style.display = 'none';
        $mandadoPeso.style.display = 'none';
        $mandadoPrecio.style.display = 'none';
        $btnAgregarArticulo.style.display = 'none';
    }

    function renderMandadoList() {
        $listaMandado.innerHTML = '';
        mandadoTicket.items.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="nombre">${item.nombre}</span><span class="precio">${fmt.format(item.monto)}</span>`;
            $listaMandado.appendChild(li);
        });
        $totalTicket.textContent = fmt.format(mandadoTicket.total);
    }

    function guardarTicket() {
        if (mandadoTicket.total <= 0) {
            mostrarNotificacion("❗ No hay artículos para guardar", 'error');
            return;
        }

        agregarRegistro("Mandado", mandadoTicket.total);
        ocultarPantallaMandado();
    }

    // Event Listeners
    aplicarCortesPendientes();
    renderResumen();
    $btnConfirmar.addEventListener("click", () => agregarRegistro($tipo.value, parseFloat($monto.value)));
    $monto.addEventListener("keydown", e => { if (e.key === "Enter") agregarRegistro($tipo.value, parseFloat($monto.value)); });
    $btnHistorial.addEventListener("click", toggleHistorial);
    $tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
    
    // Eventos de la nueva funcionalidad
    $btnMandado.addEventListener('click', mostrarPantallaMandado);
    $btnVolver.addEventListener('click', ocultarPantallaMandado);
    $mandadoCategoria.addEventListener('change', actualizarProductosDropdown);
    $btnAgregarArticulo.addEventListener('click', agregarArticulo);
    $btnGuardarTicket.addEventListener('click', guardarTicket);
    $mandadoProducto.addEventListener('change', () => $mandadoPrecio.focus());
  </script>
</body>
</html>