<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mi Control Financiero</title>

  <meta name="theme-color" content="#121212" />
  <meta name="background-color" content="#121212" />

  <link rel="manifest" href="/manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Finanzas">

  <link rel="apple-touch-icon" href="./icon-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="./icon-512x512.png">

  <meta name="description" content="Una aplicación simple para llevar el control de tus finanzas personales y mandado.">
  <meta name="author" content="Ulises Luna">
    
  <style>
  /* Safe area para iOS */
body {
  padding-top: constant(safe-area-inset-top); /* Soporte iOS viejo */
  padding-top: env(safe-area-inset-top);      /* Soporte actual */
  padding-left: constant(safe-area-inset-left);
  padding-left: env(safe-area-inset-left);
  padding-right: constant(safe-area-inset-right);
  padding-right: env(safe-area-inset-right);
  padding-bottom: constant(safe-area-inset-bottom);
  padding-bottom: env(safe-area-inset-bottom);
}

 html {
    height: 100%;
    background: var(--bg-color);

    padding-top: env(safe-area-inset-top);
    padding-right: env(safe-area-inset-right);
    padding-bottom: env(safe-area-inset-bottom);
    padding-left: env(safe-area-inset-left);
  }

  body {
    margin: 0;
    height: 100%;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
    background: var(--bg-color);
    color: var(--text-color);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 16px; /* este es tu espacio normal dentro del safe-area */
    box-sizing: border-box;
  }
  
  /* Corrección para evitar el zoom en inputs en iOS */
  input[type="number"]:focus,
  input[type="text"]:focus {
    font-size: 16px; /* Asegura un tamaño mínimo que evita el zoom */
  }

    /* ====== VARIABLES DE TEMA ====== */
    :root {
      --bg-color: #0f0f10;
      --card-bg: #121212;
      --card-border: #232323;
      --text-color: #f1f1f1;
      --text-light: #a9a9a9;
      --input-bg: #171717;
      --input-border: #242424;
      --primary-btn-bg: #2b7cff;
      --secondary-btn-bg: #202020;
      --secondary-btn-border: #2d2d2d;
      --border-soft: #1f1f1f;
      --header-bg: #161616;
      --accent-green: #66bb6a;
      --accent-red: #ef5350;
      --accent-blue: #4fc3f7;
      
      /* Colores para categorías de mandado */
      --color-higiene-personal: #42a5f5; /* Azul */
      --color-frutas-verduras: #66bb6a; /* Verde */
      --color-carnes: #ef5350; /* Rojo */
      --color-abarrotes: #ff9800; /* Naranja (CORRECCIÓN) */
      --color-otros: #a9a9a9; /* Gris */
    }

    [data-theme="light"] {
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --card-border: #e0e0e0;
      --text-color: #333333;
      --text-light: #666666;
      --input-bg: #f9f9f9;
      --input-border: #e0e0e0;
      --primary-btn-bg: #1e88e5;
      --secondary-btn-bg: #e0e0e0;
      --secondary-btn-border: #bdbdbd;
      --border-soft: #e9e9e9;
      --header-bg: #f5f5f5;
      --accent-green: #2e7d32;
      --accent-red: #c62828;
      --accent-blue: #0277bd;
      
      /* Colores para categorías de mandado (tema claro) */
      --color-higiene-personal: #1976d2;
      --color-frutas-verduras: #388e3c;
      --color-carnes: #c62828;
      --color-abarrotes: #ef6c00; /* Naranja (CORRECCIÓN) */
      --color-otros: #666666;
    }

    /* ====== RESET & BASE ====== */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      padding: 16px;
      overflow-x: hidden;
      position: relative;
    }

    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: .2px;
      color: var(--text-color);
    }
    
    .theme-switcher {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 24px;
      background: none;
      border: none;
      color: var(--text-light);
      cursor: pointer;
      line-height: 1;
    }

    /* ====== PANEL SUPERIOR ====== */
    .panel {
      width: 100%;
      max-width: 560px;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.15);
      transition: opacity 0.3s ease;
    }

    .panel.hidden {
      opacity: 0;
      height: 0;
      padding: 0;
      margin: 0;
      border: none;
      pointer-events: none;
      transform: translateY(-100%);
      position: absolute;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      align-items: stretch;
    }

    .metric {
      background: var(--input-bg);
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 10px 8px;
      text-align: center;
    }
    .metric .label {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .6px;
    }
    .metric .value {
      font-weight: 700;
      font-size: clamp(16px, 4.3vw, 20px);
    }
    .metric.ahorro .value { color: var(--accent-blue); }
    .metric.saldo  .value { color: var(--accent-green); }
    .metric.gastos .value { color: var(--accent-red); }
    .metric.deudas .value { color: #f7931a; }
    .metric.efectivo .value { color: #50c878; }

    /* ====== MAIN FORM & ACTIONS ====== */
    .screen {
        width: 100%;
        max-width: 560px;
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }
    .screen.active {
        display: flex;
    }

    .input-area {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
    }
    .input-area input,
    .input-area select,
    .btn {
      border: 1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-color);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 16px;
      outline: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .input-area select {
        padding-right: 30px;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down" style="color: %23a9a9a9;"><polyline points="6 9 12 15 18 9"></polyline></svg>');
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 18px;
    }
    [data-theme="light"] .input-area select {
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down" style="color: %23666666;"><polyline points="6 9 12 15 18 9"></polyline></svg>');
    }
    .btn {
      cursor: pointer;
      font-weight: 600;
      transition: transform .06s ease, background .2s ease;
      background: var(--primary-btn-bg);
      border-color: var(--primary-btn-bg);
    }
    .btn:active { transform: translateY(1px); }
    .btn.secundario {
      background: var(--secondary-btn-bg);
      border-color: var(--secondary-btn-border);
    }
    .btn.secundario:hover { background: var(--secondary-btn-bg); }

    /* Ajuste de tamaño para los botones de la lista de mandado y pagos */
    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      font-size: 16px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .actions {
      width: 100%;
      display: flex;
      gap: 10px;
      margin-top: -8px;
    }
    .actions .btn { flex: 1; }

    /* ====== PANTALLA DE MANDADO ====== */
    #mandado-screen header, #mandado-historial-screen header, #mandado-detalle-screen header,
    #deudas-screen header, #deuda-detalle-screen header, #pagos-mensuales-screen header, #pago-mensual-detalle-screen header,
    #efectivo-screen header {
      width: 100%;
      max-width: 560px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #mandado-screen .input-item {
      width: 100%;
      max-width: 560px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    #mandado-screen .input-item .grid-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    #mandado-screen #lista-mandado,
    #mandado-historial-lista,
    #mandado-detalle-lista,
    #deudas-lista,
    #pagos-mensuales-lista,
    #efectivo-historial-lista {
      list-style: none;
      padding: 0;
      width: 100%;
      max-width: 560px;
      margin: 0;
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      background: var(--card-bg);
    }
    #mandado-screen #lista-mandado li,
    #mandado-historial-lista li,
    #mandado-detalle-lista li,
    #deudas-lista li,
    #pagos-mensuales-lista li,
    #efectivo-historial-lista li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border-soft);
      font-size: 15px;
      cursor: pointer;
    }
    #mandado-screen #lista-mandado li:last-child,
    #mandado-historial-lista li:last-child,
    #mandado-detalle-lista li:last-child,
    #deudas-lista li:last-child,
    #pagos-mensuales-lista li:last-child,
    #efectivo-historial-lista li:last-child {
      border-bottom: none;
    }
    #mandado-screen #lista-mandado li .nombre,
    #mandado-historial-lista li .nombre,
    #mandado-detalle-lista li .nombre,
    #deudas-lista li .nombre,
    #pagos-mensuales-lista li .nombre,
    #efectivo-historial-lista li .nombre {
      flex: 1;
      color: var(--text-light);
    }
    /* Estilos para el color de la fuente del nombre del artículo del mandado */
    #mandado-screen #lista-mandado li .nombre.higiene { color: var(--color-higiene-personal); }
    #mandado-screen #lista-mandado li .nombre.frutas { color: var(--color-frutas-verduras); }
    #mandado-screen #lista-mandado li .nombre.carnes { color: var(--color-carnes); }
    #mandado-screen #lista-mandado li .nombre.abarrotes { color: var(--color-abarrotes); } /* CORRECCIÓN */
    #mandado-screen #lista-mandado li .nombre.otros { color: var(--color-otros); }
    
    #mandado-screen #lista-mandado li .cantidad,
    #mandado-detalle-lista li .cantidad {
        font-size: 13px;
        color: var(--text-light);
    }
    #mandado-screen #lista-mandado li .nombre,
    #mandado-screen #lista-mandado li .precio {
        font-weight: bold; /* CORRECCIÓN: Nombres y precios en negritas */
    }
    
    #mandado-historial-lista li .precio,
    #mandado-detalle-lista li .precio,
    #deudas-lista li .monto,
    #pagos-mensuales-lista li .monto {
      font-weight: 600;
    }

    #mandado-screen #lista-mandado li .actions {
      display: flex;
      gap: 8px;
      flex: none;
      margin: 0;
    }

    /* CORRECCIÓN: Ajuste para los botones de la lista de mandado */
    #mandado-screen #lista-mandado li .actions .btn {
      width: 28px;
      height: 28px;
      padding: 0;
      font-size: 12px;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #deudas-lista li .acciones {
        display: flex;
        gap: 8px;
    }
    #deudas-lista .fecha {
        font-size: 12px;
        color: var(--text-light);
        margin-left: auto;
    }
    #deuda-detalle-screen .deuda-info {
      width: 100%;
      max-width: 560px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      background: var(--card-bg);
      text-align: center;
    }
    #deuda-detalle-screen .deuda-info .titulo {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
    }
    #deuda-detalle-screen .deuda-info .monto {
        font-size: 18px;
        color: var(--accent-red);
    }
    
    /* CORRECCIÓN: Estilos para que el historial de pagos no desborde */
    #deuda-detalle-screen #pagos-lista {
        overflow-y: auto;
        max-height: 300px;
    }
    
    /* === NUEVOS ESTILOS PARA LA PROYECCIÓN DE DEUDAS === */
    .deuda-proyeccion {
        width: 100%;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }
    
    .deuda-proyeccion .label-proyeccion {
        font-size: 13px;
        color: var(--text-light);
        font-weight: 500;
        margin-top: 4px;
    }

    .deuda-proyeccion .valor-proyeccion {
        font-size: 16px;
        font-weight: 600;
    }
    
    /* NUEVOS ESTILOS: Inputs de proyeccion */
    .deuda-proyeccion input[type="number"], .deuda-proyeccion select {
        width: auto;
        padding: 6px 10px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 14px;
    }
    
    .deuda-proyeccion .input-group {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .progress-bar-container {
        width: 100%;
        background-color: var(--input-bg);
        border-radius: 8px;
        height: 16px;
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--accent-green);
        transition: width 0.3s ease-in-out;
    }

    .progress-text {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-color);
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-shadow: 0 0 4px rgba(0,0,0,0.6);
    }
    
    .progress-container {
        position: relative;
    }
    /* === FIN NUEVOS ESTILOS === */
    
    /* === NUEVOS ESTILOS PARA PAGOS MENSUALES === */
    #pagos-mensuales-screen .input-item {
      width: 100%;
      max-width: 560px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    #pagos-mensuales-lista li {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 10px 14px;
        gap: 6px;
    }
    #pagos-mensuales-lista li .info-line {
        display: flex;
        justify-content: space-between;
        width: 100%;
        align-items: center;
    }
    #pagos-mensuales-lista li .nombre {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-color);
    }
    #pagos-mensuales-lista li .monto-info {
        font-size: 14px;
        color: var(--text-light);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    #pagos-mensuales-lista li .monto-info .monto-total {
        font-weight: 600;
        color: var(--accent-green);
    }
    #pagos-mensuales-lista li .actions {
        display: flex;
        gap: 8px;
        margin-left: auto;
    }

    #pago-mensual-detalle-screen .pago-info {
      width: 100%;
      max-width: 560px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 14px;
      border: 1px solid var(--card-border);
      border-radius: 12px;
      background: var(--card-bg);
      text-align: center;
    }
    #pago-mensual-detalle-screen .pago-info .titulo {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 4px;
    }
    #pago-mensual-detalle-screen .pago-info .monto-total {
        font-size: 18px;
        color: var(--accent-green);
    }
    #pago-mensual-detalle-screen .pago-info .monto-pendiente {
        font-size: 16px;
        color: var(--accent-red);
        font-weight: 600;
    }
    
    #pago-mensual-detalle-screen .pago-mensual-proyeccion {
        width: 100%;
        text-align: left;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    #pago-mensual-detalle-screen .pago-mensual-proyeccion .label-proyeccion {
        font-size: 13px;
        color: var(--text-light);
        font-weight: 500;
        margin-top: 4px;
    }
    /* === FIN NUEVOS ESTILOS === */


    #mandado-screen .total-container,
    #mandado-historial-screen .total-container,
    #deuda-detalle-screen .total-container,
    #efectivo-historial-screen .total-container {
      width: 100%;
      max-width: 560px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 20px;
      font-weight: bold;
      padding: 14px;
      border-radius: 12px;
      background: var(--input-bg);
    }
    #mandado-screen .total-container .valor,
    #mandado-historial-screen .total-container .valor { color: var(--accent-green); }
    
    /* === NUEVOS ESTILOS PARA TOTALES POR CATEGORÍA === */
    #mandado-categoria-totales {
        width: 100%;
        max-width: 560px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        margin-top: 10px;
        padding: 14px;
        border-radius: 12px;
        background: var(--card-bg);
    }
    
    .categoria-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 15px;
    }
    .categoria-total .nombre {
        font-weight: 600;
    }
    .categoria-total .monto {
        font-weight: 600;
    }
    /* === FIN NUEVOS ESTILOS === */

    /* ====== HISTORIAL & GRAFICO ====== */
    #historial, #efectivo-historial {
      width: 100%;
      max-width: 560px;
      display: none;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 14px;
      margin-top: 10px;
    }
    #historial header, #efectivo-historial header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      border-bottom: 1px solid var(--card-border);
      font-weight: 700;
      font-size: 15px;
      background: var(--header-bg);
      border-top-left-radius: 14px;
      border-top-right-radius: 14px;
    }
    
    .tabs {
        display: flex;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
    }
    .tab {
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        background: var(--secondary-btn-bg);
    }
    .tab.active {
        background: var(--primary-btn-bg);
        color: white;
    }

    .historial-content {
      padding: 0;
    }
    .semana, .mes {
      padding: 10px 14px 2px;
      border-bottom: 1px dashed var(--card-border);
    }
    .semana .rango, .mes .rango {
      font-size: 12px;
      color: var(--text-light);
      margin-bottom: 8px;
    }
    .registro {
      display: grid;
      grid-template-columns: auto 1fr auto auto;
      gap: 6px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-soft);
      font-size: 14px;
      align-items: center;
    }
    .registro:last-child { border-bottom: none; }
    .registro .tipo {
      color: var(--text-color);
      font-weight: 600;
      display: flex;
      align-items: center;
    }
    .registro .tipo .icono {
      margin-right: 6px;
      font-size: 1.2em;
    }
    .registro .monto {
      justify-self: end;
      font-weight: 600;
    }
    .registro .delete-btn {
      background: none;
      border: none;
      color: var(--accent-red);
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
    }
    .registro .fecha {
      color: var(--text-light);
      font-size: 12px;
      grid-column: 1 / -1;
      text-align: right;
    }
    
    /* Estilos para el historial de pagos de deudas */
    #pagos-lista li.pago-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 14px;
        border-bottom: 1px solid var(--border-soft);
        font-size: 15px;
        cursor: default;
    }
    
    #pagos-lista li.pago-item:last-child {
        border-bottom: none;
    }
    
    #pagos-lista li.pago-item .pago-info-container {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }

    #pagos-lista li.pago-item .fecha {
      font-size: 12px;
      color: var(--text-light);
    }
    
    #pagos-lista li.pago-item .monto {
      font-weight: 600;
      color: var(--text-color);
      margin-right: auto;
    }

    /* CORRECCIÓN: Ajuste para que los botones de eliminar del historial de pagos no desborden */
    #pagos-lista li .actions {
      display: flex;
      gap: 8px;
      flex: none;
      margin: 0;
      align-items: center;
    }
    
    #pagos-lista li .actions .btn {
        /* Ajuste de tamaño para los botones del historial de pagos */
        width: 24px;
        height: 24px;
        padding: 0;
        font-size: 12px;
        line-height: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* ====== GRAFICO CIRCULAR ====== */
    #chart-container {
        padding: 16px 14px;
        background: var(--card-bg);
        display: none;
        border-bottom-left-radius: 14px;
        border-bottom-right-radius: 14px;
        border: 1px solid var(--card-border);
        border-top: none;
    }
    #chart-container h3 {
        margin: 0 0 10px;
        font-size: 16px;
        color: var(--text-color);
    }
    #chart {
        width: 100%;
        height: 250px;
        max-width: 300px;
        margin: auto;
    }

    /* ====== Notificacion ====== */
    #notificacion {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--primary-btn-bg);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1000;
      display: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 15px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    @media (max-width: 500px) {
      .input-area { 
        grid-template-columns: 1fr;
        gap: 8px;
      }
      .input-area button {
        width: 100%;
      }
      .registro { grid-template-columns: 1fr 1fr auto auto; }
      .registro .fecha { grid-column: auto; text-align: left; margin-top: 4px; }
      #mandado-screen .input-item { grid-template-columns: 1fr; }
    }
    
    #add-category-btn, #add-debt-btn, #add-monthly-payment-btn, #btn-ir-efectivo {
      background: none;
      border: 1px solid var(--input-border);
      border-radius: 12px;
      padding: 10px;
      color: var(--text-color);
      cursor: pointer;
      font-size: 14px;
      transition: background .2s ease;
      margin-top: -10px;
      width: 100%;
      text-align: center;
    }
    #add-monthly-payment-btn, #btn-ir-efectivo {
        margin-top: 0;
    }

    #add-category-btn:hover, #add-debt-btn:hover, #add-monthly-payment-btn:hover, #btn-ir-efectivo:hover {
        background: var(--input-bg);
    }

    /* Estilos para el modal de añadir categoría/deuda */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .modal-content {
        background-color: var(--card-bg);
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        width: 90%;
        max-width: 400px;
        display: flex;
        flex-direction: column;
        gap: 16px;
    }
    .modal-content input, .modal-content textarea {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background: var(--input-bg);
        color: var(--text-color);
        font-size: 16px;
    }
    .modal-content textarea {
        resize: vertical;
        min-height: 80px;
    }
    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    .modal-buttons .btn {
        flex: 0 1 auto;
    }
    .modal-buttons .btn.cancel {
        background: transparent;
        border: 1px solid var(--secondary-btn-border);
        color: var(--text-color);
    }
    
    #pagar-deuda-modal input {
        width: 100%;
    }

    /* ESTILOS ESPECÍFICOS PARA LA PANTALLA DE EFECTIVO */
    #efectivo-screen .panel {
        display: flex;
        justify-content: center;
    }
    
    #efectivo-screen .metrics {
        grid-template-columns: 1fr;
    }
    
    #efectivo-screen .input-area {
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    
    #efectivo-screen .input-area input,
    #efectivo-screen .input-area select,
    #efectivo-screen .input-area .btn {
        width: 100%;
    }
    
    .efectivo-actions {
        display: flex;
        flex-direction: column;
        width: 100%;
        gap: 10px;
    }
    
  </style>
</head>
<body>
  <h1>💰 Mi Control Financiero</h1>
  <button id="theme-switcher" class="theme-switcher">☀️</button>

  <section id="main-panel" class="panel">
    <div class="metrics">
      <div class="metric ahorro">
        <div class="label">Ahorro</div>
        <div id="ahorro" class="value">$0.00</div>
      </div>
      <div class="metric saldo">
        <div class="label">Saldo total</div>
        <div id="saldo" class="value">$0.00</div>
      </div>
      <div class="metric gastos">
        <div class="label">Gastos</div>
        <div id="gastos" class="value">$0.00</div>
      </div>
      <div class="metric deudas">
        <div class="label">Deudas</div>
        <div id="deudas-total" class="value">$0.00</div>
      </div>
    </div>
  </section>

  <div id="main-screen" class="screen active">
      <section class="input-area">
        <input type="number" id="monto" placeholder="Monto (ej. 2000, -200 para retirar de Ahorro)" />
        <select id="tipo">
          <option value="Sueldo">Sueldo</option>
          <option value="Depósito">Depósito</option>
          <option value="Ahorro">Ahorro</option>
          <option value="Mandado">Mandado</option>
          <option value="Efectivo">Efectivo</option>
          <option value="Telmex">Telmex</option>
          <option value="CFE">CFE</option>
          <option value="Tienda">Tienda</option>
          <option value="Corning">Corning</option>
          <option value="Didi">Didi</option>
          <option value="iCloud">iCloud</option>
          <option value="Coppel">Coppel</option>
          <option value="Otros">Otros</option>
        </select>
        <button class="btn" id="btn-confirmar">Confirmar</button>
      </section>
      <button id="add-category-btn">➕ Añadir categoría de gasto</button>

      <section class="actions">
        <button class="btn secundario" id="btn-historial">📜 Ver historial y análisis</button>
        <button class="btn secundario" id="btn-mandado">🛒 Ir al Mandado</button>
      </section>
      <button id="add-debt-btn">📝 Gestionar deudas</button>
      <button id="add-monthly-payment-btn">🗓️ Pagos mensuales</button>
      <button id="btn-ir-efectivo">💵 Efectivo</button>

      <section id="historial">
        <header>
          Historial
          <div class="tabs">
              <div class="tab active" data-view="semana">Semanal</div>
              <div class="tab" data-view="mes">Mensual</div>
              <div class="tab" data-view="analisis">Análisis</div>
              <div class="tab" data-view="line-chart">Tendencias</div>
          </div>
        </header>
        <div id="contenedorSemanas" class="historial-content"></div>
        <div id="contenedorMeses" class="historial-content" style="display: none;"></div>
        <div id="chart-container" class="historial-content" style="display: none;">
            <h3>Distribución de Gastos</h3>
            <canvas id="chart"></canvas>
        </div>
        <div id="line-chart-container" class="historial-content" style="display: none;">
            <h3>Tendencia de Gastos</h3>
            <canvas id="line-chart"></canvas>
        </div>
      </section>
  </div>
  
  <section id="efectivo-screen" class="screen">
      <header>
          <h2>Administrar Efectivo</h2>
          <button class="btn secundario" id="btn-volver-efectivo">Volver</button>
      </header>
      <section class="panel">
          <div class="metrics">
              <div class="metric efectivo">
                  <div class="label">Efectivo Total</div>
                  <div id="efectivo-total" class="value">$0.00</div>
              </div>
          </div>
      </section>
      <section class="efectivo-actions">
        <div class="input-area">
            <input type="number" id="monto-efectivo" placeholder="Monto" />
            <select id="tipo-efectivo">
                <option value="Mandado">Mandado</option>
                <option value="Tienda">Tienda</option>
                <option value="Otros">Otros</option>
            </select>
            <button class="btn" id="btn-confirmar-efectivo">Confirmar</button>
        </div>
        <button id="add-efectivo-category-btn">➕ Añadir concepto</button>
      </section>
      <section id="efectivo-historial">
          <header>Historial de gastos en efectivo</header>
          <div id="contenedorSemanasEfectivo" class="historial-content"></div>
      </section>
  </section>

  <section id="mandado-screen" class="screen">
      <header>
          <h2>Ticket del Mandado</h2>
          <button class="btn secundario" id="btn-volver-mandado">Volver</button>
      </header>
      
      <div class="input-item">
          <select id="mandado-categoria">
              <option value="">Selecciona Categoría</option>
              <option value="Frutas y Verduras">Frutas y Verduras</option>
              <option value="Abarrotes">Abarrotes</option>
              <option value="Higiene Personal">Higiene Personal</option>
              <option value="Carnes">Carnes</option>
              <option value="Otros">Otros</option>
          </select>
          <select id="mandado-producto" style="display: none;"></select>
          <input type="text" id="nombre-articulo" placeholder="Nombre del artículo" style="display: none;">

          <div class="grid-inputs">
              <input type="text" id="mandado-peso" placeholder="Peso (ej. 0.800 kg)" style="display: none;" inputmode="decimal" pattern="[0-9]*[.]?[0-9]*">
              <input type="number" id="mandado-cantidad" placeholder="Cantidad" step="1" style="display: none;" inputmode="numeric" pattern="[0-9]*">
              <input type="text" id="mandado-precio" placeholder="Precio (ej. 20.00 pz)" style="display: none;" inputmode="decimal" pattern="[0-9]*[.]?[0-9]*">
          </div>
          <button class="btn" id="btn-agregar-articulo" style="display: none;">➕ Agregar</button>
      </div>

      <ul id="lista-mandado">
          </ul>

      <div class="total-container">
          <span>Total del ticket:</span>
          <span class="valor" id="total-ticket">$0.00</span>
      </div>

      <div id="mandado-categoria-totales">
      </div>

      <button class="btn secundario" id="btn-historial-mandado">🧾 Historial de mandados</button>
      <button class="btn" id="btn-guardar-ticket">✅ Guardar Ticket</button>
  </section>

  <section id="mandado-historial-screen" class="screen">
    <header>
      <h2>Historial de Mandados</h2>
      <button class="btn secundario" id="btn-volver-historial">Volver</button>
    </header>
    <ul id="mandado-historial-lista">
        </ul>
  </section>

  <section id="mandado-detalle-screen" class="screen">
    <header>
      <h2 id="detalle-titulo"></h2>
      <button class="btn secundario" id="btn-volver-detalle">Volver</button>
    </header>
    <ul id="mandado-detalle-lista">
        </ul>
    <div class="total-container">
        <span>Total del ticket:</span>
        <span class="valor" id="detalle-total">$0.00</span>
    </div>
  </section>
  
  <section id="deudas-screen" class="screen">
    <header>
        <h2>Gestionar Deudas</h2>
        <button class="btn secundario" id="btn-volver-deudas">Volver</button>
    </header>
    <div class="input-item">
        <input type="text" id="deuda-nombre" placeholder="Nombre de la deuda" />
        <input type="number" id="deuda-monto-inicial" placeholder="Monto inicial" />
        <button class="btn" id="btn-agregar-deuda">➕ Agregar Deuda</button>
    </div>
    <ul id="deudas-lista">
        </ul>
  </section>

  <section id="deuda-detalle-screen" class="screen">
    <header>
        <h2 id="deuda-detalle-titulo"></h2>
        <button class="btn secundario" id="btn-volver-deuda-detalle">Volver</button>
    </header>
    <div class="deuda-info">
        <span class="titulo" id="deuda-info-nombre"></span>
        <span class="monto" id="deuda-info-pendiente"></span>
        <div class="progress-container">
            <div id="progress-bar" class="progress-bar-container">
                <div class="progress-bar"></div>
            </div>
            <span id="progress-text" class="progress-text">0%</span>
        </div>
        <div class="deuda-proyeccion">
            <div class="input-group">
                <label for="promedio-pago-input" class="label-proyeccion">Promedio de pago: </label>
                <input type="number" id="promedio-pago-input" placeholder="$" step="0.01" />
            </div>
            <div class="input-group">
                <label for="promedio-dias-input" class="label-proyeccion">Días entre pagos: </label>
                <input type="number" id="promedio-dias-input" placeholder="#" step="1" />
            </div>
            <span class="label-proyeccion">Fecha de liquidación estimada: <span class="valor-proyeccion" id="fecha-liquidación">--</span></span>
        </div>
        <div class="input-area" style="grid-template-columns: 1fr auto;">
            <input type="number" id="deuda-pago-monto" placeholder="Monto a pagar" />
            <button class="btn" id="btn-registrar-pago">✅ Pagar</button>
        </div>
    </div>
    <h3>Historial de pagos</h3>
    <ul id="pagos-lista"></ul>
  </section>

  <section id="pagos-mensuales-screen" class="screen">
    <header>
        <h2>Pagos mensuales</h2>
        <button class="btn secundario" id="btn-volver-pagos-mensuales">Volver</button>
    </header>
    <div class="input-item">
        <input type="text" id="pago-mensual-nombre" placeholder="Nombre del pago (ej. Telmex)" />
        <input type="number" id="pago-mensual-monto" placeholder="Monto total del mes" />
        <button class="btn" id="btn-agregar-pago-mensual">➕ Agregar pago</button>
    </div>
    <ul id="pagos-mensuales-lista">
        </ul>
  </section>
  
  <div id="add-category-modal" class="modal">
      <div class="modal-content">
          <h3>Añadir nueva categoría</h3>
          <input type="text" id="new-category-name" placeholder="Ej. Restaurantes" />
          <div class="modal-buttons">
              <button class="btn secundario cancel" id="cancel-category-btn">Cancelar</button>
              <button class="btn" id="save-category-btn">Guardar</button>
          </div>
      </div>
  </div>

  <div id="add-efectivo-concept-modal" class="modal">
      <div class="modal-content">
          <h3>Añadir nuevo concepto de efectivo</h3>
          <input type="text" id="new-efectivo-concept-name" placeholder="Ej. Mandado, Transporte, Tienda" />
          <textarea id="new-efectivo-concept-note" placeholder="Nota del gasto (opcional)"></textarea>
          <div class="modal-buttons">
              <button class="btn secundario cancel" id="cancel-efectivo-concept-btn">Cancelar</button>
              <button class="btn" id="save-efectivo-concept-btn">Guardar</button>
          </div>
      </div>
  </div>
  
  <div id="notificacion" style="display: none;"></div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <script type="module">
    // Importa las funciones que necesitas del SDKs modular
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, doc, getDoc, setDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Tu configuración de la aplicación web de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDRq70PInWyj7pjYPGGqMQWaVe_tbrwebI",
      authDomain: "mi-control-financiero-9099a.firebaseapp.com",
      projectId: "mi-control-financiero-9099a",
      storageBucket: "mi-control-financiero-9099a.firebasestorage.app",
      messagingSenderId: "275253747474",
      appId: "1:275253747474:web:d696e1c786bd58c9799dcb"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const fmt = new Intl.NumberFormat("es-MX", { style: "currency", currency: "MXN" });
    const mesesLargos = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    const mesesCortos = ["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"];
    let myChart, myLineChart;
    // === MODIFICACIÓN 1: mandadoTicket ahora también guarda los totales por categoría ===
    let mandadoTicket = { items: [], total: 0, categoryTotals: {} };
    let editIndex = null;
    let currentDebtId = null;
    let state = {}; // El estado ahora se gestiona desde Firebase

    const productosMandado = {
        "Frutas y Verduras": [
            "Aguacate", "Ajo", "Apio", "Brócoli", "Calabaza", "Camote", "Cebolla", "Cebollin",
            "Chayote", "Chile habanero", "Chile jalapeño", "Chile Poblano", "Cilantro", "Ciruela",
            "Coco", "Durazno", "Ejotes", "Elotes", "Espinaca", "Fresas", "Germen de Soya", "Guayaba",
            "Jamaica", "Lechuga", "Limón", "Mango", "Manzanas", "Melon", "Naranjas", "Nopales",
            "Papa", "Papaya", "Pera", "Plátano", "Repollo", "Sandia", "Tamarindo", "Tomate", "Tuna",
            "Uva", "Zacate de limón", "Zanahoria"
        ],
        "Abarrotes": [
            "Aceite", "Ajo en polvo", "Arroz", "Arroz con leche", "Atún", "Avena", "Azucar", "Azúcar glass",
            "BBQ", "Bolillo", "Bolsa ziploc", "Cafe", "Canela", "Catsup", "Cereal", "Chile color",
            "Chiles en vinagre", "Chocomilk", "Clamato", "Cóctel de frutas", "Comino", "Consomate",
            "Crema", "Cremora", "Cuernitos", "Elotitos", "Empanizador", "Flan", "Frijol", "Frijoles rancheros",
            "Granola", "Galletas", "Galletas saladas", "Harina", "Harina para hot cakes", "Harina para pastel",
            "Horchata", "Huevo", "Laurel", "Leche", "Leche carnation", "Lechera", "Lechitas", "Macarrones",
            "Maizena", "Mantequilla", "Maruchan", "Mayonesa", "Mermelada", "Mole", "Mostaza", "Nieve",
            "Pan blanco", "Pan dulce", "Pan para hamburguesa", "Pan para hotdog", "Pan tostado", "Papa congelada",
            "Papel de aluminio", "Pimienta", "Puré de tomate", "Puré huntz", "Queso amarillo", "Queso menonita",
            "Queso Philadelphia", "Ranch", "Sal", "Sal con cebolla", "Salsa botanera",
            "Salsa picante", "Sazonador", "Servitoallas", "Sopa de coditos", "Spaguetti", "Tamarindo",
            "Te de manzanilla", "Tortilla amarilla", "Tortillas de harina", "Tostadas", "Yakult", "Yogurth",
            "Zukos"
        ],
        "Higiene Personal": [
            "Aromatizante", "Bolsas para basura", "Cepillo dental", "Cortina para baño", "Cloro",
            "Desengrasante", "Desodorante", "Fabuloso", "Esponja para trastes", "Gel", "Guantes",
            "Jabón en polvo", "Jabón para baño", "Jabón para manos", "Jabón para ropa", "Jabón para trastes",
            "Jabón zote", "Magitel", "Papel de baño", "Pasta de dientes", "Pastillas para baño",
            "Pastillas para taza", "Pinol", "Plantillas", "Raidolitos", "Rastrillos", "shampoo",
            "Sponja para bañarse", "Suavizante", "Talco", "Toallas sanitarias"
        ],
        "Carnes": [
            "Carne molida", "Bistec", "Pechuga", "Higado", "Pescado", "Flecha", "Costilla", "Desherbada",
            "Pollo", "Tocino", "Carne para hamburguesas", "Alitas", "Puerco", "Flautas congeladas",
            "Jamón", "Salchicha", "Chorizo"
        ],
        "Otros": ["Otros"]
    };
    
    // Función para obtener el color de la categoría
    function obtenerColorCategoria(categoria) {
        switch(categoria) {
            case "Higiene Personal":
                return "higiene";
            case "Frutas y Verduras":
                return "frutas";
            case "Carnes":
                return "carnes";
            case "Abarrotes": // CORRECCIÓN
                return "abarrotes";
            default:
                return "otros";
        }
    }

    // =========================================================================
    // ✅ CAMBIO: Lógica para los cortes semanales de jueves a jueves
    // =========================================================================
    function inicioSemanaJueves(fecha) {
        const d = new Date(fecha);
        const day = d.getDay(); // 0 = domingo, 1 = lunes... 4 = jueves
        const diff = (day < 4) ? (day + 3) : (day - 4);
        d.setDate(d.getDate() - diff);
        d.setHours(0,0,0,0);
        return d;
    }
    
    function finSemanaDesdeInicio(inicio) {
        const end = new Date(inicio);
        end.setDate(end.getDate() + 6);
        end.setHours(23, 59, 59, 999);
        return end;
    }

    function rangoSemanaTexto(inicio) {
        const fin = finSemanaDesdeInicio(inicio);
        const opciones = { day: '2-digit', month: 'short' };
        return `Semana: ${inicio.toLocaleDateString('es-MX', opciones)} — ${fin.toLocaleDateString('es-MX', opciones)}`;
    }

    function fechaDisplay(tipo, dateObj = new Date()) {
      const dd = String(dateObj.getDate()).padStart(2,"0");
      const mm = String(dateObj.getMonth()+1).padStart(2,"0");
      const yyyy = dateObj.getFullYear();
      if (tipo === "Sueldo" || tipo === "Depósito") return `${dd}/${mm}/${yyyy}`;
      const hh = String(dateObj.getHours()).padStart(2,"0");
      const min = String(dateObj.getMinutes()).padStart(2,"0");
      return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
    }
    function obtenerMesAno(timestamp) {
        const fecha = new Date(timestamp);
        return `${mesesLargos[fecha.getMonth()]} ${fecha.getFullYear()}`;
    }

    const $saldo = document.getElementById("saldo");
    const $ahorro = document.getElementById("ahorro");
    const $gastos = document.getElementById("gastos");
    const $deudasTotal = document.getElementById("deudas-total");
    const $monto = document.getElementById("monto");
    const $tipo  = document.getElementById("tipo");
    const $btnConfirmar = document.getElementById("btn-confirmar");
    const $btnHistorial = document.getElementById("btn-historial");
    const $btnMandado = document.getElementById("btn-mandado");
    const $historial = document.getElementById("historial");
    const $contenedorSemanas = document.getElementById("contenedorSemanas");
    const $contenedorMeses = document.getElementById("contenedorMeses");
    const $notificacion = document.getElementById("notificacion");
    const $tabs = document.querySelectorAll('.tab');
    const $chartContainer = document.getElementById('chart-container');
    const $lineChartContainer = document.getElementById('line-chart-container');
    const historialContentContainers = document.querySelectorAll('.historial-content');
    const $mainScreen = document.getElementById('main-screen');
    const $mainPanel = document.getElementById('main-panel');
    const $mandadoScreen = document.getElementById('mandado-screen');
    const $mandadoCategoria = document.getElementById('mandado-categoria');
    const $mandadoProducto = document.getElementById('mandado-producto');
    const $nombreArticulo = document.getElementById('nombre-articulo');
    const $mandadoPeso = document.getElementById('mandado-peso');
    const $mandadoCantidad = document.getElementById('mandado-cantidad'); // NUEVO
    const $mandadoPrecio = document.getElementById('mandado-precio');
    const $btnAgregarArticulo = document.getElementById('btn-agregar-articulo');
    const $listaMandado = document.getElementById('lista-mandado');
    const $totalTicket = document.getElementById('total-ticket');
    const $mandadoCategoriaTotales = document.getElementById('mandado-categoria-totales'); // NUEVO
    const $btnGuardarTicket = document.getElementById('btn-guardar-ticket');
    const $btnVolverMandado = document.getElementById('btn-volver-mandado');
    const $btnHistorialMandado = document.getElementById('btn-historial-mandado');
    const $mandadoHistorialScreen = document.getElementById('mandado-historial-screen');
    const $btnVolverHistorial = document.getElementById('btn-volver-historial');
    const $mandadoHistorialLista = document.getElementById('mandado-historial-lista');
    const $mandadoDetalleScreen = document.getElementById('mandado-detalle-screen');
    const $btnVolverDetalle = document.getElementById('btn-volver-detalle');
    const $detalleTitulo = document.getElementById('detalle-titulo');
    const $detalleTotal = document.getElementById('detalle-total');
    const $mandadoDetalleLista = document.getElementById('mandado-detalle-lista'); // Agregado
    const $themeSwitcher = document.getElementById('theme-switcher');
    const $addCategoryBtn = document.getElementById('add-category-btn');
    const $addCategoryModal = document.getElementById('add-category-modal');
    const $newCategoryName = document.getElementById('new-category-name');
    const $cancelCategoryBtn = document.getElementById('cancel-category-btn');
    const $saveCategoryBtn = document.getElementById('save-category-btn');
    const $addDebtBtn = document.getElementById('add-debt-btn');
    const $deudasScreen = document.getElementById('deudas-screen');
    const $btnVolverDeudas = document.getElementById('btn-volver-deudas');
    const $deudaNombre = document.getElementById('deuda-nombre');
    const $deudaMontoInicial = document.getElementById('deuda-monto-inicial');
    const $btnAgregarDeuda = document.getElementById('btn-agregar-deuda');
    const $deudasLista = document.getElementById('deudas-lista');
    const $deudaDetalleScreen = document.getElementById('deuda-detalle-screen');
    const $btnVolverDeudaDetalle = document.getElementById('btn-volver-deuda-detalle');
    const $deudaInfoNombre = document.getElementById('deuda-info-nombre');
    const $deudaInfoPendiente = document.getElementById('deuda-info-pendiente');
    const $deudaPagoMonto = document.getElementById('deuda-pago-monto');
    const $btnRegistrarPago = document.getElementById('btn-registrar-pago');
    const $pagosLista = document.getElementById('pagos-lista');
    // Nuevos elementos para la proyección
    const $promedioPagoInput = document.getElementById('promedio-pago-input');
    const $promedioDiasInput = document.getElementById('promedio-dias-input');
    const $fechaLiquidacion = document.getElementById('fecha-liquidación');
    const $progressBar = document.querySelector('#progress-bar .progress-bar');
    const $progressText = document.getElementById('progress-text');

    // NUEVOS ELEMENTOS PARA PAGOS MENSUALES
    const $btnPagosMensuales = document.getElementById('add-monthly-payment-btn');
    const $pagosMensualesScreen = document.getElementById('pagos-mensuales-screen');
    const $btnVolverPagosMensuales = document.getElementById('btn-volver-pagos-mensuales');
    const $pagoMensualNombre = document.getElementById('pago-mensual-nombre');
    const $pagoMensualMonto = document.getElementById('pago-mensual-monto');
    const $btnAgregarPagoMensual = document.getElementById('btn-agregar-pago-mensual');
    const $pagosMensualesLista = document.getElementById('pagos-mensuales-lista');

    // NUEVOS ELEMENTOS PARA EFECTIVO
    const $btnIrEfectivo = document.getElementById('btn-ir-efectivo');
    const $efectivoScreen = document.getElementById('efectivo-screen');
    const $btnVolverEfectivo = document.getElementById('btn-volver-efectivo');
    const $efectivoTotal = document.getElementById('efectivo-total');
    const $montoEfectivo = document.getElementById('monto-efectivo');
    const $tipoEfectivo = document.getElementById('tipo-efectivo');
    const $btnConfirmarEfectivo = document.getElementById('btn-confirmar-efectivo');
    const $efectivoHistorial = document.getElementById('efectivo-historial');
    const $contenedorSemanasEfectivo = document.getElementById('contenedorSemanasEfectivo');
    // Nuevos elementos para el modal de conceptos de efectivo
    const $addEfectivoConceptBtn = document.getElementById('add-efectivo-category-btn');
    const $addEfectivoConceptModal = document.getElementById('add-efectivo-concept-modal');
    const $newEfectivoConceptName = document.getElementById('new-efectivo-concept-name');
    const $newEfectivoConceptNote = document.getElementById('new-efectivo-concept-note');
    const $cancelEfectivoConceptBtn = document.getElementById('cancel-efectivo-concept-btn');
    const $saveEfectivoConceptBtn = document.getElementById('save-efectivo-concept-btn');
    
    function mostrarNotificacion(mensaje, tipo = 'exito') {
        $notificacion.textContent = mensaje;
        $notificacion.style.backgroundColor = (tipo === 'exito') ? 'var(--primary-btn-bg)' : 'var(--accent-red)';
        $notificacion.style.display = "block";
        setTimeout(() => {
            $notificacion.style.display = "none";
        }, 2500);
    }
    
    function actualizarCategorias() {
        const tiposExistentes = ["Sueldo", "Depósito", "Ahorro", "Mandado", "Efectivo", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros"];
        const nuevasCategorias = state.customCategories ? state.customCategories.filter(cat => !tiposExistentes.includes(cat)) : [];
        
        const fragment = document.createDocumentFragment();
        
        // Remove existing custom categories to prevent duplicates
        const existingOptions = $tipo.querySelectorAll('.custom-category');
        existingOptions.forEach(opt => opt.remove());

        // Asegurarse de que los pagos mensuales se agreguen a la lista de tipos
        const pagosMensualesNombres = (state.pagosMensuales || []).map(p => p.nombre);

        [...nuevasCategorias, ...pagosMensualesNombres].forEach(cat => {
            if (!tiposExistentes.includes(cat)) {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                option.classList.add('custom-category');
                fragment.appendChild(option);
            }
        });
        
        $tipo.appendChild(fragment);

        // Actualizar el select de la pantalla de efectivo
        const tiposEfectivo = ["Mandado", "Tienda", "Otros"];
        const nuevasCategoriasEfectivo = state.customEfectivoCategories ? state.customEfectivoCategories.filter(cat => !tiposEfectivo.includes(cat)) : [];
        const fragmentEfectivo = document.createDocumentFragment();
        
        const existingOptionsEfectivo = $tipoEfectivo.querySelectorAll('.custom-category');
        existingOptionsEfectivo.forEach(opt => opt.remove());
        
        nuevasCategoriasEfectivo.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            option.classList.add('custom-category');
            fragmentEfectivo.appendChild(option);
        });
        $tipoEfectivo.appendChild(fragmentEfectivo);
    }

    function renderResumen() {
      $saldo.textContent  = fmt.format(state.saldo || 0);
      $ahorro.textContent = fmt.format(state.ahorro || 0);
      // ✅ CORRECCIÓN: Aquí se llama a la nueva función para calcular los gastos semanales
      $gastos.textContent = fmt.format(calcularGastosSemanales());
      $deudasTotal.textContent = fmt.format(calcularDeudasTotal());
      $efectivoTotal.textContent = fmt.format(state.efectivo || 0);
    }
    
    // ✅ NUEVA FUNCIÓN: Para calcular los gastos de la semana en curso
    function calcularGastosSemanales() {
        const hoy = new Date();
        const inicioSemanaActual = inicioSemanaJueves(hoy);
        let gastosSemanales = 0;
        
        if (state.registros) {
            state.registros.forEach(r => {
                const fechaRegistro = new Date(r.ts instanceof Timestamp ? r.ts.toDate() : r.ts);
                // Tipos de transacción que son considerados gastos
                const esGastoGeneral = ["Mandado", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros", ...(state.customCategories || [])].includes(r.tipo);
                // Gastos de efectivo, que tienen un tipo que comienza con "Efectivo: " y un monto negativo
                const esGastoEfectivo = r.tipo.startsWith("Efectivo: ") && r.monto < 0;
                
                const esGastoValido = esGastoGeneral || esGastoEfectivo;
                
                if (esGastoValido && fechaRegistro >= inicioSemanaActual) {
                    const montoGasto = Math.abs(r.monto);
                    gastosSemanales += montoGasto;
                }
            });
        }
        return gastosSemanales;
    }

    // Funciones de sincronización con Firestore
    async function initFirestore() {
      const docRef = doc(db, "finanzas", "estado_principal");
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists()) {
        // Inicializar la base de datos si no existe
        state = { saldo: 0, ahorro: 0, gastos: 0, efectivo: 0, deudas: [], registros: [], mandadoTickets: [], ultimaCorte: null, customCategories: [], customEfectivoCategories: [], pagosMensuales: [] };
        await setDoc(docRef, state);
      } else {
        state = docSnap.data();
        // Asegúrate de que los arrays existan si son nuevos campos
        if (!state.deudas) state.deudas = [];
        if (!state.registros) state.registros = [];
        if (!state.mandadoTickets) state.mandadoTickets = [];
        if (!state.customCategories) state.customCategories = [];
        if (!state.customEfectivoCategories) state.customEfectivoCategories = [];
        if (!state.pagosMensuales) state.pagosMensuales = [];
        if (!state.efectivo) state.efectivo = 0;
        // Reconvertir timestamps de Firestore a objetos Date
        state.registros = state.registros.map(r => ({ ...r, ts: r.ts instanceof Timestamp ? r.ts.toDate().getTime() : r.ts }));
        // Asegúrate de que los pagos de deudas también tengan timestamps numéricos
        state.deudas = state.deudas.map(d => ({
            ...d,
            pagos: (d.pagos || []).map(p => ({ ...p, ts: p.ts instanceof Timestamp ? p.ts.toDate().getTime() : p.ts })),
            // === NUEVA LÓGICA: Inicializar los nuevos campos si no existen ===
            promedioPago: d.promedioPago || 0,
            promedioDias: d.promedioDias || 0
        }));
      }
      
      aplicarCortesPendientes();
      actualizarCategorias();
      renderResumen();
      renderHistorial();
      renderHistorialEfectivo();
    }
    
    async function persist() {
        state.deudasTotal = calcularDeudasTotal();
        const docRef = doc(db, "finanzas", "estado_principal");
        // Asegúrate de que los timestamps sean compatibles con Firestore
        const stateToSave = { 
            ...state, 
            registros: state.registros.map(r => ({ ...r, ts: Timestamp.fromMillis(r.ts) })),
            deudas: state.deudas.map(d => ({
                ...d,
                pagos: (d.pagos || []).map(p => ({ ...p, ts: Timestamp.fromMillis(p.ts) }))
            }))
        };
        await setDoc(docRef, stateToSave);
    }
    
    function calcularDeudasTotal() {
        let total = 0;
        if (state.deudas) {
            state.deudas.forEach(d => {
                if (d.montoPendiente > 0) {
                    total += d.montoPendiente;
                }
            });
        }
        return total;
    }

    // =========================================================================
    // ✅ CAMBIO: Lógica de corte semanal reconfigurada
    // =========================================================================
    function aplicarCortesPendientes() {
        const hoy = new Date();
        const ultimoJuevesHoy = inicioSemanaJueves(hoy);
        
        if (!state.ultimaCorte) {
            state.ultimaCorte = ultimoJuevesHoy.toISOString();
            persist();
            return;
        }

        let corte = new Date(state.ultimaCorte);
        while (corte.getTime() < ultimoJuevesHoy.getTime()) {
            const siguienteCorte = new Date(corte);
            siguienteCorte.setDate(siguienteCorte.getDate() + 7);
            
            // Si la siguiente fecha de corte es posterior a hoy, no hacer el corte aún.
            if (siguienteCorte.getTime() > hoy.getTime()) {
                break;
            }
            
            state.registros.push({ id: Date.now(), tipo:"CIERRE", monto:0, fecha:fechaDisplay("Otros", siguienteCorte), ts:siguienteCorte.getTime() });
            state.gastos = 0;
            corte = siguienteCorte;
        }
        state.ultimaCorte = ultimoJuevesHoy.toISOString();
        persist();
    }


    async function agregarRegistro(tipo, monto, id = null, isEfectivo = false) {
      if (isNaN(monto) || monto === 0) {
        mostrarNotificacion("❗ Monto inválido", 'error');
        return;
      }
      const now = new Date();
      const registro = {
          id: id || now.getTime(),
          tipo,
          monto,
          fecha: fechaDisplay(tipo, now),
          ts: now.getTime()
      };

      if (tipo === "Sueldo" || tipo === "Depósito") {
        state.saldo += monto;
      } else if (tipo === "Ahorro") {
        if (monto < 0) {
          state.ahorro += monto;
          state.saldo += Math.abs(monto);
        } else {
          state.ahorro += monto;
          state.saldo -= monto;
        }
      } else if (tipo === "Efectivo") {
          // Esto es para la transferencia de saldo a efectivo.
          if (monto > state.saldo) {
            mostrarNotificacion("❗ Saldo insuficiente para retirar", 'error');
            return;
          }
          state.efectivo += monto;
          state.saldo -= monto;
      } else {
          // =========================================================================
          // ✅ CAMBIO: Ya no se suma a state.gastos aquí. El cálculo se hace en renderResumen()
          // =========================================================================
          state.saldo -= monto;
          
          const pagoMensual = state.pagosMensuales.find(p => p.nombre === tipo);
          if (pagoMensual) {
              pagoMensual.montoCompletado += monto;
          }
      }

      state.registros.push(registro);
      await persist();
      renderResumen();
      mostrarNotificacion("✅ Transacción registrada");
      renderHistorial();
      renderPagosMensualesList();
      renderHistorialEfectivo();
    }
    
    async function agregarGastoEfectivo(tipo, monto, nota = '') {
        if (isNaN(monto) || monto <= 0) {
            mostrarNotificacion("❗ Monto inválido", 'error');
            return;
        }

        if (monto > state.efectivo) {
            mostrarNotificacion("❗ Gasto mayor que el efectivo disponible", 'error');
            return;
        }

        state.efectivo -= monto;
        
        const now = new Date();
        const registro = {
            id: now.getTime(),
            tipo: `Efectivo: ${tipo}`,
            monto: -monto, // Registrar como un valor negativo para distinguirlo
            fecha: fechaDisplay(tipo, now),
            nota: nota,
            ts: now.getTime()
        };
        state.registros.push(registro);
        
        // NO se suma a state.gastos para evitar duplicación
        await persist();
        renderResumen();
        mostrarNotificacion("✅ Gasto de efectivo registrado");
        renderHistorialEfectivo();
        $montoEfectivo.value = '';
        $tipoEfectivo.value = "Otros";
    }

    async function eliminarRegistro(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este registro?')) {
            return;
        }

        const index = state.registros.findIndex(r => r.id == id);
        if (index === -1) {
            // Buscamos si es un pago de deuda
            const debtPaymentIdMatch = id.match(/^pago-(\d+)-(\d+)$/);
            if (debtPaymentIdMatch) {
                const [, debtId, pagoId] = debtPaymentIdMatch;
                const deudaIndex = state.deudas.findIndex(d => d.id == debtId);
                if (deudaIndex !== -1) {
                    const pagoIndex = state.deudas[deudaIndex].pagos.findIndex(p => p.id == pagoId);
                    if (pagoIndex !== -1) {
                        const montoPago = state.deudas[deudaIndex].pagos[pagoIndex].monto;
                        state.deudas[deudaIndex].montoPendiente += montoPago;
                        state.deudas[deudaIndex].pagos.splice(pagoIndex, 1);
                        state.registros.splice(index, 1);
                        
                        await persist();
                        renderResumen();
                        renderHistorial();
                        mostrarNotificacion("🗑️ Registro de pago eliminado");
                        return;
                    }
                }
            }
            mostrarNotificacion("❌ Registro no encontrado", 'error');
            return;
        }
        
        const registro = state.registros[index];
        const { tipo, monto } = registro;

        // Invertir el efecto del registro en los totales
        if (tipo === "Sueldo" || tipo === "Depósito") {
            state.saldo -= monto;
        } else if (tipo === "Ahorro") {
            if (monto < 0) {
                state.ahorro -= monto;
                state.saldo -= Math.abs(monto);
            } else {
                state.ahorro -= monto;
                state.saldo += monto;
            }
        } else if (tipo.startsWith("Efectivo: ")) { // Si es un gasto de efectivo...
            state.efectivo -= monto; // notar que monto es negativo, por lo que suma
        } else if (tipo === "Efectivo" && monto > 0) { // Si es una recarga a efectivo
            state.efectivo -= monto;
            state.saldo += monto;
        } else {
            // =========================================================================
            // ✅ CAMBIO: Revertir un gasto general
            // =========================================================================
            state.saldo += monto;
        }

        state.registros.splice(index, 1);
        await persist();
        renderResumen();
        renderHistorial();
        renderHistorialEfectivo();
        mostrarNotificacion("🗑️ Registro eliminado");
    }
    
    function esGastoEfectivo(tipo) {
        return tipo.startsWith("Efectivo: ");
    }


    function obtenerIconoTipo(tipo) {
        const gastos = ["Mandado", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros", "CIERRE", ...(state.customCategories || [])];
        const pagosMensualesNombres = (state.pagosMensuales || []).map(p => p.nombre);
        if (tipo === "Sueldo") return "🟢";
        if (tipo === "Depósito") return "💰";
        if (tipo === "Ahorro") return "🟡";
        if (tipo === "Efectivo") return "💵";
        if (tipo.startsWith("Efectivo: ")) return "💸";
        if (gastos.includes(tipo) || pagosMensualesNombres.includes(tipo)) return "🔴";
        return "";
    }

    function crearRegistroHTML(registro) {
        const div = document.createElement("div");
        div.className = "registro";
        const icono = obtenerIconoTipo(registro.tipo);
        const montoDisplay = registro.monto < 0 ? fmt.format(Math.abs(registro.monto)) : fmt.format(registro.monto);
        div.innerHTML = `<div class="tipo"><span class="icono">${icono}</span>${registro.tipo}</div><div class="monto">${montoDisplay}</div><button class="delete-btn" data-id="${registro.id}">✖️</button><div class="fecha">${registro.fecha}</div>`;
        return div;
    }

    function agruparPorSemana() {
      if (!state.registros) return [];
      // =========================================================================
      // ✅ CAMBIO: Excluir los gastos de efectivo del historial general
      // =========================================================================
      const grupos = new Map();
      const registrosFiltrados = state.registros.filter(r => !r.tipo.startsWith("Efectivo: "));
      const registrosConFechas = registrosFiltrados.map(r => ({ ...r, ts: r.ts instanceof Timestamp ? r.ts.toDate().getTime() : r.ts }));
      
      for (const r of registrosConFechas) {
        const inicio = inicioSemanaJueves(r.ts);
        const key = inicio.toISOString();
        if (!grupos.has(key)) grupos.set(key, { inicio, items: [] });
        grupos.get(key).items.push(r);
      }
      return Array.from(grupos.values()).sort((a,b) => b.inicio - a.inicio);
    }
    
    function agruparPorMes() {
        if (!state.registros) return [];
        // =========================================================================
        // ✅ CAMBIO: Excluir los gastos de efectivo del historial general
        // =========================================================================
        const registrosFiltrados = state.registros.filter(r => !r.tipo.startsWith("Efectivo: "));
        const grupos = new Map();
        const registrosConFechas = registrosFiltrados.map(r => ({ ...r, ts: r.ts instanceof Timestamp ? r.ts.toDate().getTime() : r.ts }));
        
        for (const r of registrosConFechas) {
            const mesAno = obtenerMesAno(r.ts);
            if (!grupos.has(mesAno)) grupos.set(mesAno, { nombre: mesAno, items: [] });
            grupos.get(mesAno).items.push(r);
        }
        return Array.from(grupos.values()).sort((a, b) => b.items[0].ts - a.items[0].ts);
    }

    function renderHistorial() {
      $contenedorSemanas.innerHTML = "";
      const gruposSemanas = agruparPorSemana();
      for (const g of gruposSemanas) {
        const divSemana = document.createElement("div");
        divSemana.className = "semana";
        const rango = document.createElement("div");
        rango.className = "rango";
        rango.textContent = rangoSemanaTexto(g.inicio);
        divSemana.appendChild(rango);

        g.items.sort((a,b)=>b.ts-a.ts).forEach(r => {
          const registroEl = crearRegistroHTML(r);
          divSemana.appendChild(registroEl);
        });
        $contenedorSemanas.appendChild(divSemana);
      }

      $contenedorMeses.innerHTML = "";
      const gruposMeses = agruparPorMes();
      for (const g of gruposMeses) {
          const divMes = document.createElement("div");
          divMes.className = "mes";
          const rango = document.createElement("div");
          rango.className = "rango";
          rango.textContent = g.nombre;
          divMes.appendChild(rango);

          g.items.sort((a,b)=>b.ts-a.ts).forEach(r => {
              const registroEl = crearRegistroHTML(r);
              divMes.appendChild(registroEl);
          });
          $contenedorMeses.appendChild(divMes);
      }
      
      document.querySelectorAll('#historial .delete-btn').forEach(btn => {
          btn.addEventListener('click', (e) => eliminarRegistro(e.currentTarget.dataset.id));
      });
    }

    function renderHistorialEfectivo() {
        $contenedorSemanasEfectivo.innerHTML = "";
        const gastosEfectivo = state.registros.filter(r => r.monto < 0 && r.tipo.startsWith("Efectivo: "));
        const recargasEfectivo = state.registros.filter(r => r.tipo === "Efectivo" && r.monto > 0);
        
        const todosLosRegistrosEfectivo = [...gastosEfectivo, ...recargasEfectivo].sort((a, b) => b.ts - a.ts);

        if (todosLosRegistrosEfectivo.length === 0) {
            $efectivoHistorial.style.display = 'none';
            return;
        }
        $efectivoHistorial.style.display = 'block';

        const grupos = new Map();
        for (const r of todosLosRegistrosEfectivo) {
          const inicio = inicioSemanaJueves(r.ts);
          const key = inicio.toISOString();
          if (!grupos.has(key)) grupos.set(key, { inicio, items: [] });
          grupos.get(key).items.push(r);
        }
        
        const gruposSemanasEfectivo = Array.from(grupos.values()).sort((a,b) => b.inicio - a.inicio);
        for (const g of gruposSemanasEfectivo) {
            const divSemana = document.createElement("div");
            divSemana.className = "semana";
            const rango = document.createElement("div");
            rango.className = "rango";
            rango.textContent = rangoSemanaTexto(g.inicio);
            divSemana.appendChild(rango);

            g.items.sort((a,b)=>b.ts-a.ts).forEach(r => {
                const registroEl = crearRegistroHTML(r);
                divSemana.appendChild(registroEl);
            });
            $contenedorSemanasEfectivo.appendChild(divSemana);
        }
    }

    function renderChart() {
        const gastos = (state.registros || []).filter(r => {
            const tipoGastos = ["Mandado", "Efectivo", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros", "CIERRE", ...(state.customCategories || [])];
            return tipoGastos.includes(r.tipo) && r.monto > 0;
        });
        
        const gastosPorCategoria = gastos.reduce((acc, curr) => {
            acc[curr.tipo] = (acc[curr.tipo] || 0) + curr.monto;
            return acc;
        }, {});
        
        const labels = Object.keys(gastosPorCategoria);
        const data = Object.values(gastosPorCategoria);
        
        if (myChart) myChart.destroy();
        
        const ctx = document.getElementById('chart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#E7E9ED', '#A0522D', '#20B2AA', '#778899', '#D2691E', '#CD5C5C', '#3e95cd', '#8e5ea2', '#3cba9f', '#e8c3b9', '#c45850'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: getComputedStyle(document.body).getPropertyValue('--text-light')
                        }
                    }
                }
            }
        });
    }
    
    function renderLineChart() {
        const gastos = (state.registros || []).filter(r => r.monto > 0 && r.tipo !== "Sueldo" && r.tipo !== "Depósito" && r.tipo !== "Ahorro" && r.tipo !== "CIERRE" && !r.tipo.startsWith("Efectivo: "));
        const gastosPorFecha = gastos.reduce((acc, curr) => {
            const date = new Date(curr.ts instanceof Timestamp ? curr.ts.toDate() : curr.ts).toISOString().slice(0, 10);
            if (!acc[date]) acc[date] = 0;
            acc[date] += curr.monto;
            return acc;
        }, {});
        
        const labels = Object.keys(gastosPorFecha).sort();
        const data = labels.map(date => gastosPorFecha[date]);
        
        if (myLineChart) myLineChart.destroy();
        
        const ctx = document.getElementById('line-chart').getContext('2d');
        myLineChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Gasto Diario Total',
                    data: data,
                    borderColor: 'var(--accent-red)',
                    backgroundColor: 'rgba(239, 83, 80, 0.2)',
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day'
                        },
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Monto'
                        }
                    }
                }
            }
        });
    }

    function toggleHistorial() {
      if ($historial.style.display === "block") {
        $historial.style.display = "none";
      } else {
        $historial.style.display = "block";
        handleTabClick({ currentTarget: document.querySelector('.tab.active') });
      }
    }
    
    function handleTabClick(event) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        event.currentTarget.classList.add('active');
        const view = event.currentTarget.dataset.view;
        
        historialContentContainers.forEach(c => c.style.display = 'none');
        
        if (view === 'semana') {
            $contenedorSemanas.style.display = 'block';
            renderHistorial();
        } else if (view === 'mes') {
            $contenedorMeses.style.display = 'block';
            renderHistorial();
        } else if (view === 'analisis') {
            $chartContainer.style.display = 'block';
            renderChart();
        } else if (view === 'line-chart') {
            $lineChartContainer.style.display = 'block';
            renderLineChart();
        }
    }

    // Funcionalidad de Mandado
    // =========================================================================
    // ✅ CAMBIO: Renderizar historial de efectivo al cambiar de pantalla
    // =========================================================================
    function mostrarPantalla(id) {
        document.querySelectorAll('.screen').forEach(s => {
            s.classList.remove('active');
        });
        document.getElementById(id).classList.add('active');
        
        // Ocultar/mostrar el panel de saldos
        if (id === 'main-screen') {
            $mainPanel.classList.remove('hidden');
        } else {
            $mainPanel.classList.add('hidden');
        }

        // Se asegura de que el historial de efectivo se renderice CADA VEZ que
        // se entra a esa pantalla, solucionando el problema.
        if (id === 'efectivo-screen') {
            renderHistorialEfectivo();
        }
    }

    function mostrarPantallaMandado() {
        mostrarPantalla('mandado-screen');
        limpiarFormularioMandado(); 
    }
    
    function limpiarFormularioMandado() {
        mandadoTicket = { items: [], total: 0, categoryTotals: {} };
        editIndex = null;
        renderMandadoList();
        $mandadoCategoria.value = '';
        $mandadoProducto.style.display = 'none';
        $nombreArticulo.style.display = 'none';
        $mandadoPeso.style.display = 'none';
        $mandadoCantidad.style.display = 'none';
        $mandadoPrecio.style.display = 'none';
        $btnAgregarArticulo.style.display = 'none';
        $btnAgregarArticulo.textContent = "➕ Agregar";
    }

    function actualizarProductosDropdown() {
        const categoria = $mandadoCategoria.value;
        const productos = productosMandado[categoria] || [];
        $mandadoProducto.innerHTML = `<option value="">Selecciona Producto</option>`;
        
        if (categoria) {
            productos.sort().forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                $mandadoProducto.appendChild(option);
            });
            $mandadoProducto.style.display = (categoria === 'Otros') ? 'none' : 'block';
            $nombreArticulo.style.display = (categoria === 'Otros') ? 'block' : 'none';
            $mandadoPeso.style.display = (categoria === 'Frutas y Verduras') ? 'block' : 'none';
            $mandadoCantidad.style.display = (categoria === 'Abarrotes' || categoria === 'Higiene Personal' || categoria === 'Carnes') ? 'block' : 'none';
            $mandadoPrecio.style.display = 'block';
            $btnAgregarArticulo.style.display = 'block';
        } else {
            $mandadoProducto.style.display = 'none';
            $nombreArticulo.style.display = 'none';
            $mandadoPeso.style.display = 'none';
            $mandadoCantidad.style.display = 'none';
            $mandadoPrecio.style.display = 'none';
            $btnAgregarArticulo.style.display = 'none';
        }
    }
    
    function agregarArticulo() {
        const categoria = $mandadoCategoria.value;
        let nombre = '';
        let monto = 0;
        let cantidad = 0;
        let unidad = '';
        
        if (categoria === 'Otros') {
            nombre = $nombreArticulo.value.trim();
        } else {
            nombre = $mandadoProducto.value;
        }

        if (!nombre) {
            mostrarNotificacion("❗ Selecciona un producto", 'error');
            return;
        }

        const precio = parseFloat($mandadoPrecio.value);
        if (isNaN(precio) || precio <= 0) {
            mostrarNotificacion("❗ Ingresa un precio válido", 'error');
            return;
        }

        if (categoria === "Frutas y Verduras") {
            cantidad = parseFloat($mandadoPeso.value);
            if (isNaN(cantidad) || cantidad <= 0) {
                mostrarNotificacion("❗ Ingresa un peso válido", 'error');
                return;
            }
            monto = cantidad * precio;
            unidad = "kg";
        } else if (categoria === "Abarrotes" || categoria === "Higiene Personal" || categoria === "Carnes") {
            cantidad = parseInt($mandado-cantidad.value);
            if (isNaN(cantidad) || cantidad <= 0) {
                mostrarNotificacion("❗ Ingresa una cantidad válida", 'error');
                return;
            }
            monto = cantidad * precio;
            unidad = "pz";
        } else {
            cantidad = 1;
            monto = precio;
            unidad = "pz";
        }
        
        const articulo = { nombre, monto, cantidad, unidad, categoria };

        if (editIndex !== null) {
            const oldItem = mandadoTicket.items[editIndex];
            mandadoTicket.total -= oldItem.monto;
            mandadoTicket.total += articulo.monto;
            
            mandadoTicket.categoryTotals[oldItem.categoria] -= oldItem.monto;
            mandadoTicket.categoryTotals[articulo.categoria] = (mandadoTicket.categoryTotals[articulo.categoria] || 0) + articulo.monto;

            mandadoTicket.items[editIndex] = articulo;
            
            editIndex = null;
            $btnAgregarArticulo.textContent = "➕ Agregar";
        } else {
            mandadoTicket.items.push(articulo);
            mandadoTicket.total += articulo.monto;
            mandadoTicket.categoryTotals[articulo.categoria] = (mandadoTicket.categoryTotals[articulo.categoria] || 0) + articulo.monto;
        }

        renderMandadoList();
        $mandadoCategoria.value = '';
        $mandadoProducto.style.display = 'none';
        $nombreArticulo.value = '';
        $nombreArticulo.style.display = 'none';
        $mandadoPeso.value = '';
        $mandadoCantidad.value = '';
        $mandadoPrecio.value = '';
        $mandadoPeso.style.display = 'none';
        $mandadoCantidad.style.display = 'none';
        $mandadoPrecio.style.display = 'none';
        $btnAgregarArticulo.style.display = 'none';
    }
    
    function eliminarArticuloDelTicket(index) {
        if (index >= 0 && index < mandadoTicket.items.length) {
            const item = mandadoTicket.items[index];
            mandadoTicket.total -= item.monto;
            mandadoTicket.categoryTotals[item.categoria] -= item.monto;
            if (mandadoTicket.categoryTotals[item.categoria] <= 0) {
                delete mandadoTicket.categoryTotals[item.categoria];
            }
            mandadoTicket.items.splice(index, 1);
            renderMandadoList();
        }
    }
    
    function editarArticuloDelTicket(index) {
        const item = mandadoTicket.items[index];
        if (!item) return;
        
        editIndex = index;
        
        $mandadoCategoria.value = item.categoria;
        actualizarProductosDropdown();
        
        if (item.categoria === "Otros") {
            $nombreArticulo.value = item.nombre;
        } else {
            $mandadoProducto.value = item.nombre;
        }
        
        if (item.unidad === "kg") {
            $mandadoPeso.value = item.cantidad;
            $mandadoPrecio.value = (item.monto / item.cantidad).toFixed(2);
        } else if (item.unidad === "pz") {
            $mandadoCantidad.value = item.cantidad;
            $mandadoPrecio.value = (item.monto / item.cantidad).toFixed(2);
        } else {
            $mandadoPrecio.value = item.monto;
        }
        
        $btnAgregarArticulo.textContent = "✅ Actualizar";
        $mandadoPrecio.focus();
    }

    function renderMandadoList() {
        $listaMandado.innerHTML = '';
        mandadoTicket.items.forEach((item, index) => {
            const li = document.createElement('li');
            const cantidadDisplay = item.unidad === 'kg' ? `${item.cantidad} kg` : `${item.cantidad} pz`;
            const colorClass = obtenerColorCategoria(item.categoria);
            li.innerHTML = `
                <span class="nombre ${colorClass}">${item.nombre}</span>
                <span class="cantidad">${cantidadDisplay}</span>
                <span class="precio">${fmt.format(item.monto)}</span>
                <div class="actions">
                    <button class="btn-icon secundario edit-item" data-index="${index}">✏️</button>
                    <button class="btn-icon secundario delete-item" data-index="${index}">🗑️</button>
                </div>
            `;
            $listaMandado.appendChild(li);
        });
        $totalTicket.textContent = fmt.format(mandadoTicket.total);
        renderCategoryTotals();
    }

    function renderCategoryTotals() {
        $mandadoCategoriaTotales.innerHTML = '';
        const categoriasOrdenadas = Object.keys(mandadoTicket.categoryTotals).sort();
        categoriasOrdenadas.forEach(categoria => {
            const total = mandadoTicket.categoryTotals[categoria];
            if (total > 0) {
                const div = document.createElement('div');
                div.className = 'categoria-total';
                const colorClass = obtenerColorCategoria(categoria);
                div.innerHTML = `<span class="nombre ${colorClass}">${categoria}:</span> <span class="monto">${fmt.format(total)}</span>`;
                $mandadoCategoriaTotales.appendChild(div);
            }
        });
    }

    async function guardarTicket() {
        if (mandadoTicket.total <= 0) {
            mostrarNotificacion("❗ No hay artículos para guardar", 'error');
            return;
        }

        const now = new Date();
        const ticketCompleto = {
            id: now.getTime(),
            fecha: fechaDisplay("Mandado", now),
            total: mandadoTicket.total,
            items: mandadoTicket.items
        };
        state.mandadoTickets.push(ticketCompleto);
        
        await agregarRegistro("Mandado", mandadoTicket.total);

        await persist();
        mostrarNotificacion("✅ Ticket guardado en el historial");
        mostrarPantalla('main-screen');
        limpiarFormularioMandado();
    }

    function mostrarHistorialMandados() {
        mostrarPantalla('mandado-historial-screen');
        $mandadoHistorialLista.innerHTML = '';
        (state.mandadoTickets || []).sort((a, b) => b.id - a.id).forEach(ticket => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="nombre">Ticket del ${ticket.fecha}</span><span class="precio">${fmt.format(ticket.total)}</span>
              <div class="actions"><button class="btn-icon secundario delete-ticket-btn" data-id="${ticket.id}">🗑️</button></div>`;
            li.dataset.id = ticket.id;
            $mandadoHistorialLista.appendChild(li);
        });
    }

    async function eliminarTicketMandado(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este ticket?')) {
            return;
        }

        const index = state.mandadoTickets.findIndex(t => t.id == id);
        if (index === -1) {
            mostrarNotificacion("❌ Ticket no encontrado", 'error');
            return;
        }

        state.mandadoTickets.splice(index, 1);
        await persist();
        mostrarNotificacion("🗑️ Ticket eliminado");
        mostrarHistorialMandados();
    }

    function mostrarDetalleMandado(id) {
        const ticket = (state.mandadoTickets || []).find(t => t.id == id);
        if (!ticket) {
            mostrarNotificacion("Ticket no encontrado", "error");
            return;
        }

        mostrarPantalla('mandado-detalle-screen');
        $detalleTitulo.textContent = `Detalle del ticket (${ticket.fecha})`;
        $detalleTotal.textContent = fmt.format(ticket.total);
        $mandadoDetalleLista.innerHTML = '';
        ticket.items.forEach(item => {
            const li = document.createElement('li');
            const cantidadDisplay = item.unidad === 'kg' ? `${item.cantidad} kg` : `${item.cantidad} pz`;
            const colorClass = obtenerColorCategoria(item.categoria);
            li.innerHTML = `<span class="nombre ${colorClass}">${item.nombre}</span><span class="cantidad">${cantidadDisplay}</span><span class="precio">${fmt.format(item.monto)}</span>`;
            $mandadoDetalleLista.appendChild(li);
        });
    }

    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
        $themeSwitcher.textContent = newTheme === "dark" ? "☀️" : "🌙";
        if (myChart) renderChart();
        if (myLineChart) renderLineChart();
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem("theme") || "dark";
        document.documentElement.setAttribute("data-theme", savedTheme);
        $themeSwitcher.textContent = savedTheme === "dark" ? "☀️" : "🌙";
    }

    // Funcionalidad de Deudas
    function mostrarPantallaDeudas() {
        mostrarPantalla('deudas-screen');
        renderListaDeudas();
        $deudaNombre.value = '';
        $deudaMontoInicial.value = '';
    }
    
    async function agregarDeuda() {
        const nombre = $deudaNombre.value.trim();
        const montoInicial = parseFloat($deudaMontoInicial.value);
        if (!nombre || isNaN(montoInicial) || montoInicial <= 0) {
            mostrarNotificacion("❗ Ingresa un nombre y monto inicial válidos", 'error');
            return;
        }
        
        const nuevaDeuda = {
            id: Date.now(),
            nombre: nombre,
            montoOriginal: montoInicial,
            montoPendiente: montoInicial,
            fechaCreacion: new Date().toISOString(),
            pagos: [],
            promedioPago: 0,
            promedioDias: 0
        };
        
        state.deudas.push(nuevaDeuda);
        await persist();
        mostrarNotificacion(`✅ Deuda de ${nombre} agregada`);
        renderListaDeudas();
        $deudaNombre.value = '';
        $deudaMontoInicial.value = '';
        renderResumen();
    }
    
    function renderListaDeudas() {
        $deudasLista.innerHTML = '';
        (state.deudas || []).sort((a, b) => new Date(a.fechaCreacion) - new Date(b.fechaCreacion)).forEach(deuda => {
            const li = document.createElement('li');
            li.innerHTML = `<span class="nombre">${deuda.nombre}</span><span class="monto">${fmt.format(deuda.montoPendiente)}</span><span class="fecha">(${deuda.pagos.length} pagos)</span>
            <div class="acciones"><button class="btn secundario" data-id="${deuda.id}">👁️</button><button class="btn-icon secundario delete-deuda-btn" data-id="${deuda.id}">🗑️</button></div>`;
            li.querySelector('.btn').addEventListener('click', (e) => mostrarDetalleDeuda(e.currentTarget.dataset.id));
            li.querySelector('.delete-deuda-btn').addEventListener('click', (e) => eliminarDeuda(e.currentTarget.dataset.id));
            $deudasLista.appendChild(li);
        });
    }
    
    async function eliminarDeuda(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar esta deuda? Se borrará todo su historial de pagos.')) {
            return;
        }
        const index = state.deudas.findIndex(d => d.id == id);
        if (index !== -1) {
            state.deudas.splice(index, 1);
            await persist();
            mostrarNotificacion("🗑️ Deuda eliminada");
            renderListaDeudas();
            renderResumen();
        }
    }
    
    function mostrarDetalleDeuda(id) {
        const deuda = (state.deudas || []).find(d => d.id == id);
        if (!deuda) {
            mostrarNotificacion("Deuda no encontrada", "error");
            return;
        }
        
        currentDebtId = id;
        mostrarPantalla('deuda-detalle-screen');
        
        $deudaInfoNombre.textContent = deuda.nombre;
        $deudaInfoPendiente.textContent = `Pendiente: ${fmt.format(deuda.montoPendiente)} de ${fmt.format(deuda.montoOriginal)}`;
        
        $promedioPagoInput.value = deuda.promedioPago > 0 ? deuda.promedioPago : '';
        $promedioDiasInput.value = deuda.promedioDias > 0 ? deuda.promedioDias : '';
        
        recalcularProyeccion();
        
        const porcentajePagado = ((deuda.montoOriginal - deuda.montoPendiente) / deuda.montoOriginal) * 100;
        $progressBar.style.width = `${porcentajePagado}%`;
        $progressText.textContent = `${porcentajePagado.toFixed(1)}%`;
        
        renderPagosDeuda(deuda);
    }
    
    function recalcularProyeccion() {
        const deuda = (state.deudas || []).find(d => d.id == currentDebtId);
        if (!deuda) return;
        
        const avgPago = parseFloat($promedioPagoInput.value) || 0;
        const avgDias = parseInt($promedioDiasInput.value) || 0;
        
        deuda.promedioPago = avgPago;
        deuda.promedioDias = avgDias;
        persist();
        
        let fechaEstimada = 'Ingresa datos';
        if (avgPago > 0 && avgDias > 0 && deuda.montoPendiente > 0) {
            const pagosRestantes = Math.ceil(deuda.montoPendiente / avgPago);
            const diasRestantes = pagosRestantes * avgDias;
            const fechaActual = new Date();
            const fechaFinal = new Date(fechaActual.getTime() + diasRestantes * (1000 * 60 * 60 * 24));
            fechaEstimada = fechaFinal.toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
        } else if (avgPago > 0 && deuda.montoPendiente > 0) {
            const pagosRestantes = Math.ceil(deuda.montoPendiente / avgPago);
            fechaEstimada = `Aprox. ${pagosRestantes} pagos`;
        }

        $fechaLiquidacion.textContent = fechaEstimada;
    }

    function renderPagosDeuda(deuda) {
        $pagosLista.innerHTML = '';
        deuda.pagos.sort((a, b) => b.ts - a.ts).forEach(pago => {
            const li = document.createElement('li');
            li.classList.add('pago-item');
            li.innerHTML = `
                <span class="monto">${fmt.format(pago.monto)}</span>
                <div class="pago-info-container">
                    <span class="fecha">${fechaDisplay('Otros', new Date(pago.ts))}</span>
                    <button class="btn-icon secundario delete-pago-btn" data-pago-id="${pago.id}">🗑️</button>
                </div>
            `;
            $pagosLista.appendChild(li);
        });
    }
    
    async function registrarPago() {
        const montoPago = parseFloat($deudaPagoMonto.value);
        if (isNaN(montoPago) || montoPago <= 0) {
            mostrarNotificacion("❗ Ingresa un monto de pago válido", 'error');
            return;
        }
        
        const deuda = (state.deudas || []).find(d => d.id == currentDebtId);
        if (!deuda) {
            mostrarNotificacion("Deuda no encontrada", 'error');
            return;
        }
        
        if (montoPago > deuda.montoPendiente) {
            mostrarNotificacion("❗ El pago es mayor al monto pendiente", 'error');
            return;
        }
        
        const now = new Date();
        const pago = {
            monto: montoPago,
            ts: now.getTime(),
            id: now.getTime()
        };
        
        deuda.montoPendiente -= montoPago;
        deuda.pagos.push(pago);
        
        await persist();
        mostrarNotificacion(`✅ Pago de ${fmt.format(montoPago)} registrado`);
        mostrarDetalleDeuda(currentDebtId);
        $deudaPagoMonto.value = '';
    }

    async function eliminarPago(pagoId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este pago?')) {
            return;
        }
        
        const deuda = (state.deudas || []).find(d => d.id == currentDebtId);
        if (!deuda) {
            mostrarNotificacion("Deuda no encontrada", 'error');
            return;
        }
        
        const pagoIndex = deuda.pagos.findIndex(p => p.id == pagoId);
        if (pagoIndex === -1) {
            mostrarNotificacion("Pago no encontrado", 'error');
            return;
        }
        
        const pago = deuda.pagos[pagoIndex];
        deuda.montoPendiente += pago.monto;
        deuda.pagos.splice(pagoIndex, 1);
        
        await persist();
        mostrarNotificacion("🗑️ Pago eliminado");
        mostrarDetalleDeuda(currentDebtId);
    }
    
    function mostrarPantallaPagosMensuales() {
        mostrarPantalla('pagos-mensuales-screen');
        renderPagosMensualesList();
        $pagoMensualNombre.value = '';
        $pagoMensualMonto.value = '';
    }

    async function agregarPagoMensual() {
        const nombre = $pagoMensualNombre.value.trim();
        const monto = parseFloat($pagoMensualMonto.value);
        if (!nombre || isNaN(monto) || monto <= 0) {
            mostrarNotificacion("❗ Ingresa un nombre y monto válidos", 'error');
            return;
        }
        
        const pagoExistente = state.pagosMensuales.find(p => p.nombre === nombre);
        if (pagoExistente) {
            mostrarNotificacion("❗ El pago ya existe, edítalo en la lista", 'error');
            return;
        }
        
        const nuevoPago = {
            id: Date.now(),
            nombre: nombre,
            montoTotal: monto,
            montoCompletado: 0,
            fechaCreacion: new Date().toISOString(),
        };
        
        state.pagosMensuales.push(nuevoPago);
        state.customCategories.push(nombre);
        await persist();
        actualizarCategorias();
        mostrarNotificacion(`✅ Pago de ${nombre} agregado`);
        renderPagosMensualesList();
        $pagoMensualNombre.value = '';
        $pagoMensualMonto.value = '';
    }

    async function eliminarPagoMensual(id) {
        if (!confirm('¿Estás seguro de que quieres eliminar este pago mensual?')) {
            return;
        }
        const index = state.pagosMensuales.findIndex(p => p.id == id);
        if (index !== -1) {
            const nombrePago = state.pagosMensuales[index].nombre;
            state.pagosMensuales.splice(index, 1);
            
            const catIndex = state.customCategories.findIndex(c => c === nombrePago);
            if(catIndex !== -1) {
                state.customCategories.splice(catIndex, 1);
            }
            
            await persist();
            actualizarCategorias();
            mostrarNotificacion("🗑️ Pago mensual eliminado");
            renderPagosMensualesList();
        }
    }
    
    function renderPagosMensualesList() {
        $pagosMensualesLista.innerHTML = '';
        (state.pagosMensuales || []).sort((a, b) => b.id - a.id).forEach(pago => {
            const porcentaje = (pago.montoCompletado / pago.montoTotal) * 100;
            const montoPendiente = pago.montoTotal - pago.montoCompletado;
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="info-line">
                    <span class="nombre">${pago.nombre}</span>
                    <div class="actions">
                         <button class="btn-icon secundario delete-pago-mensual-btn" data-id="${pago.id}">🗑️</button>
                    </div>
                </div>
                <div class="monto-info">
                    <span>${fmt.format(pago.montoCompletado)} de <span class="monto-total">${fmt.format(pago.montoTotal)}</span></span>
                </div>
                <div class="progress-container" style="width: 100%;">
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${Math.min(porcentaje, 100)}%;"></div>
                    </div>
                    <span class="progress-text">${porcentaje.toFixed(1)}% | Pendiente: ${fmt.format(montoPendiente)}</span>
                </div>
            `;
            $pagosMensualesLista.appendChild(li);
        });
    }

    // Event Listeners
    applySavedTheme();
    
    $btnConfirmar.addEventListener("click", () => agregarRegistro($tipo.value, parseFloat($monto.value)));
    $monto.addEventListener("keydown", e => { if (e.key === "Enter") agregarRegistro($tipo.value, parseFloat($monto.value)); });
    $btnHistorial.addEventListener("click", toggleHistorial);
    $tabs.forEach(tab => tab.addEventListener('click', handleTabClick));
    
    $btnMandado.addEventListener('click', mostrarPantallaMandado);
    $btnVolverMandado.addEventListener('click', () => { mostrarPantalla('main-screen'); limpiarFormularioMandado(); });
    $mandadoCategoria.addEventListener('change', actualizarProductosDropdown);
    $btnAgregarArticulo.addEventListener('click', agregarArticulo);
    $btnGuardarTicket.addEventListener('click', guardarTicket);
    $btnHistorialMandado.addEventListener('click', mostrarHistorialMandados);
    $btnVolverHistorial.addEventListener('click', () => mostrarPantalla('mandado-screen'));
    $btnVolverDetalle.addEventListener('click', () => mostrarHistorialMandados(true));
    $themeSwitcher.addEventListener('click', toggleTheme);
    $addCategoryBtn.addEventListener('click', () => $addCategoryModal.style.display = 'flex');
    $cancelCategoryBtn.addEventListener('click', () => $addCategoryModal.style.display = 'none');
    $saveCategoryBtn.addEventListener('click', async () => {
        const newCat = $newCategoryName.value.trim();
        if (newCat && !(state.customCategories || []).includes(newCat) && !["Sueldo", "Depósito", "Ahorro", "Mandado", "Efectivo", "Telmex", "CFE", "Tienda", "Corning", "Didi", "iCloud", "Coppel", "Otros"].includes(newCat)) {
            if (!state.customCategories) state.customCategories = [];
            state.customCategories.push(newCat);
            await persist();
            actualizarCategorias();
            $newCategoryName.value = '';
            $addCategoryModal.style.display = 'none';
            mostrarNotificacion(`✅ Categoría "${newCat}" agregada`);
        } else {
            mostrarNotificacion("❗ Categoría inválida o ya existe", 'error');
        }
    });
    $addDebtBtn.addEventListener('click', mostrarPantallaDeudas);
    $btnVolverDeudas.addEventListener('click', () => mostrarPantalla('main-screen'));
    $btnAgregarDeuda.addEventListener('click', agregarDeuda);
    $btnVolverDeudaDetalle.addEventListener('click', () => mostrarPantalla('deudas-screen'));
    $btnRegistrarPago.addEventListener('click', registrarPago);
    $promedioPagoInput.addEventListener('input', recalcularProyeccion);
    $promedioDiasInput.addEventListener('input', recalcularProyeccion);
    
    $btnPagosMensuales.addEventListener('click', mostrarPantallaPagosMensuales);
    $btnVolverPagosMensuales.addEventListener('click', () => mostrarPantalla('main-screen'));
    $btnAgregarPagoMensual.addEventListener('click', agregarPagoMensual);
    $pagosMensualesLista.addEventListener('click', (event) => {
        const btn = event.target.closest('.delete-pago-mensual-btn');
        if (!btn) return;

        const id = parseInt(btn.dataset.id);
        eliminarPagoMensual(id);
    });
    
    // EVENTOS DE LA NUEVA PANTALLA DE EFECTIVO
    $btnIrEfectivo.addEventListener('click', () => mostrarPantalla('efectivo-screen'));
    $btnVolverEfectivo.addEventListener('click', () => mostrarPantalla('main-screen'));
    $btnConfirmarEfectivo.addEventListener('click', () => agregarGastoEfectivo($tipoEfectivo.value, parseFloat($montoEfectivo.value)));
    $montoEfectivo.addEventListener('keydown', e => { if (e.key === 'Enter') agregarGastoEfectivo($tipoEfectivo.value, parseFloat($montoEfectivo.value)); });
    
    // EVENTOS PARA EL MODAL DE CONCEPTOS DE EFECTIVO
    $addEfectivoConceptBtn.addEventListener('click', () => {
        $addEfectivoConceptModal.style.display = 'flex';
        $newEfectivoConceptName.value = '';
        $newEfectivoConceptNote.value = '';
    });
    $cancelEfectivoConceptBtn.addEventListener('click', () => $addEfectivoConceptModal.style.display = 'none');
    $saveEfectivoConceptBtn.addEventListener('click', async () => {
        const newConcept = $newEfectivoConceptName.value.trim();
        const note = $newEfectivoConceptNote.value.trim();
        const tiposExistentesEfectivo = ["Mandado", "Tienda", "Otros"];

        if (newConcept && !tiposExistentesEfectivo.includes(newConcept) && !(state.customEfectivoCategories || []).includes(newConcept)) {
            if (!state.customEfectivoCategories) state.customEfectivoCategories = [];
            state.customEfectivoCategories.push(newConcept);
            await persist();
            actualizarCategorias();
            $addEfectivoConceptModal.style.display = 'none';
            mostrarNotificacion(`✅ Concepto "${newConcept}" agregado`);
        } else {
            mostrarNotificacion("❗ Concepto inválido o ya existe", 'error');
        }
    });

    // Delegación de eventos para los botones de las listas
    document.body.addEventListener('click', (event) => {
        const target = event.target;

        // Botones de editar/eliminar en lista de mandado
        const mandadoBtn = target.closest('#lista-mandado .edit-item, #lista-mandado .delete-item');
        if (mandadoBtn) {
            const index = parseInt(mandadoBtn.dataset.index);
            if (mandadoBtn.classList.contains('edit-item')) {
                editarArticuloDelTicket(index);
            } else if (mandadoBtn.classList.contains('delete-item')) {
                eliminarArticuloDelTicket(index);
            }
            return;
        }

        // Clic en ticket de historial de mandado o su botón de eliminar
        const mandadoHistorialItem = target.closest('#mandado-historial-lista li');
        if (mandadoHistorialItem) {
            const deleteTicketBtn = target.closest('.delete-ticket-btn');
            if (deleteTicketBtn) {
                eliminarTicketMandado(deleteTicketBtn.dataset.id);
            } else if (mandadoHistorialItem.dataset.id) {
                mostrarDetalleMandado(mandadoHistorialItem.dataset.id);
            }
            return;
        }

        // Botón de eliminar pago de deuda
        const deletePagoBtn = target.closest('#pagos-lista .delete-pago-btn');
        if (deletePagoBtn) {
            eliminarPago(parseInt(deletePagoBtn.dataset.pagoId));
            return;
        }

        // Botón de eliminar en historial general y de efectivo
        const deleteRegistroBtn = target.closest('.delete-btn');
        if(deleteRegistroBtn) {
            eliminarRegistro(parseInt(deleteRegistroBtn.dataset.id));
        }
    });

    initFirestore();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('Service Worker registrado con éxito:', registration.scope);
          })
          .catch(error => {
            console.log('Fallo el registro del Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>